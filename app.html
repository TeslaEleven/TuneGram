<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width">
  <title>TuneGram</title>
  <link rel="icon" type="image/x-icon" href="favicon.png">
  <link rel="manifest" href="manifest.json">
  <link href="style.css" rel="stylesheet" type="text/css" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=MuseoModerno:ital,wght@0,100..900;1,100..900&family=Ubuntu:ital,wght@0,300;0,400;0,500;0,700;1,300;1,400;1,500;1,700&display=swap"
    rel="stylesheet">

  <link rel="manifest" href="manifest.json">
  <meta name="apple-music-developer-token"
    content="eyJhbGciOiJFUzI1NiIsImtpZCI6IlFOMjVSSkFEQk4ifQ.eyJpc3MiOiJRN0MyVEMzNlQyIiwiaWF0IjoxNzUzMzAyOTcxLCJleHAiOjE3NTc2MjI5NzEsIm9yaWdpbiI6WyJodHRwczovL3RnLmNvbWljc2VydmVyLm9yZyJdfQ.4xs6J1eRqq1PJktmtyIaPtH_vErmHM6MbxIV4Zs0-mQLoEsPyHhg95UTAiWNoEJagxmwyiBXaqsp7YiaQ5TItQ" />
  <meta name="apple-music-app-name" content="TuneGram" />
  <meta name="apple-music-app-build" content="2.1.0" />
  <link rel="stylesheet"
    href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
  <script src="https://unpkg.com/htmx.org@1.9.10"
    integrity="sha384-D1Kt99CQMDuVetoL1lrYwg5t+9QdHe7NLX/SoJYkXDFfX37iInKRy5xLSi8nO7UC"
    crossorigin="anonymous"></script>
  <script src="https://js-cdn.music.apple.com/musickit/v3/musickit.js" data-web-components async></script>
  <script src="https://code.jquery.com/jquery-3.7.1.slim.js"
    integrity="sha256-UgvvN8vBkgO0luPSUl2s8TIlOSYRoGFAX4jlCIm9Adc=" crossorigin="anonymous"></script>
</head>

<body>
  <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
    <filter id="liquid-glass">
      <feGaussianBlur in="SourceGraphic" stdDeviation="10" result="blur" />
      <feColorMatrix in="blur" type="matrix"
        values="1 0 0 0 0  0 1 0 0 0  0 0 1 0 0  0 0 0 20 -10"
        result="goo" />
      <feBlend in="SourceGraphic" in2="goo" mode="normal" />
    </filter>
  </svg>
  <div class="header" style="height:82px;">
    <div id="nameplate" valign="left" onclick="loadContent('nap')" hx-get="onboard.html" hx-target="#content"
      hx-swap="innerHTML swap:1s" style="border:none;margin-left:2%;flex-grow:1">
      <img id="name" src="logo.svg" alt="TuneGram"
        style="width:auto;height:55px;padding-top:15px;vertical-align: middle;padding:10px">
    </div>
    <div class="header-itms">
      <div title="Now Playing" class="header-itm" id="np-btn" onclick="loadContent('np-header')"
        hx-get="np.html?id=viewonly" hx-target="#content" hx-swap="innerHTML swap:1s">
        <p style="font-size:3em;text-align:center;" class="material-symbols-outlined">graphic_eq</p>
      </div>
      <div title="Search" class="header-itm" id="srch-btn" onclick="loadContent('srch')" hx-get="search.html"
        hx-target="#content" hx-swap="innerHTML swap:1s">
        <p style="font-size:3em;text-align:center;" class="material-symbols-outlined">search</p>
      </div>
    </div>
  </div>
  <div id="mobile-nav">
    <button class="mobile-nav-btn" id="np-btn-mobile" onclick="loadContent('np-header')" hx-get="np.html?id=viewonly"
      hx-target="#content" hx-swap="innerHTML swap:1s">
      <span class="material-symbols-outlined">graphic_eq</span>
    </button>
    <button class="mobile-nav-btn" id="srch-btn-mobile" onclick="loadContent('srch')" hx-get="search.html"
      hx-target="#content" hx-swap="innerHTML swap:1s">
      <span class="material-symbols-outlined">search</span>
    </button>
  </div>
  <div id="content">
    <div class="moving-note">
      <p style="font-size:3em;text-align:center;margin-bottom:10%;margin-left:25%;margin-right:25%;margin-top:10%"
        class="material-symbols-outlined">music_note</p>
    </div>
  </div>
  <div id="np-container" style="display:none"></div>
</body>
<script>
  var audio_;
  var hiItsQue = false
  var queue = "";
  var methodType = "";
  var targetPractice = "";

  const queryParameters = { l: 'en-us' };
  function assignVar(type, num) {
    if (type == "album") {
      albumsToCount = num;
    } else if (type == "plist") {
      plistsToCount = num
    }
  }
  var tags = ["deluxe", "live", "acoustic", "explicit", "master", "remix", "version", "bonus", "original", "soundtrack", "remastered", "reissue", "re-recorded", "re-recording", "reimagined", "reimagining", "cover", "stripped down"];
  var plistWarns = [];
  var albumsToCount = 0;
  var toDrawAlbums = ""
  var albumsProcessed = 0;
  var foldersToCount = 0;
  var toDrawFolders = ""
  var foldersProcessed = 0;
  var songsToCount = 0;
  var toDrawSongs = ""
  var songsProcessed = 0;
  var plistsToCount = 0;
  var toDrawPlists = ""
  var plistsProcessed = 0;
  var tracksToCount = 0;
  var toDrawTracks = ""
  var tracksProcessed = 0;
  var heavyToCount = 0;
  var toDrawHeavy = ""
  var heavyProcessed = 0;
  var toDrawRecs = "";
  var recsProcessed = 0;
  var recsToCount = 0;
  function boundToString(rect) {
    return `rect(w=${rect.width}, h=${rect.height})`;
  }
  document.body.addEventListener('htmx:afterSwap', function (res) {
    document.getElementById('content').style.height = "fit-content";
  })
  document.body.addEventListener('htmx:beforeSwap', function () {
    document.getElementById('content').style.height = "87.5vh";
  })
  function loadContent(page) {
    if (page !== "np" && page !== "np-header") {
      hideNowPlayingScreen();
    }
    if (page === "np" || page === "np-header") {
      if (showNowPlayingScreen()) {
        if (page == "np-header") {
          npId = "viewonly"
          document.querySelector('#np-btn').style.color = "#396E80";
          document.querySelector('#srch-btn').style.color = "#2F3633";
        }
        if (page == "np") {
          document.querySelector('#np-btn').style.color = "#396E80";
          document.querySelector('#srch-btn').style.color = "#2F3633";
        }
        // Always add blue border if artwork is present and on np tab
        const npBtn = document.getElementById('np-btn');
        const img = npBtn ? npBtn.querySelector('.np-artwork-img') : null;
        if (img && img.src && !img.src.endsWith('fallback.svg')) {
          img.classList.add('np-artwork-active');
        }
        return;
      }
    }

    document.getElementById('content').innerHTML = `<div class="moving-note"><p style="font-size:3em;text-align:center;margin-bottom:10%;margin-left:25%;margin-right:25%;margin-top:10%" class="material-symbols-outlined">music_note</p>`
    document.getElementById('content').style.display = "inline-flex";

    if (page == "srch") {
      document.querySelector('#srch-btn').style.color = "#396E80";
      document.querySelector('#np-btn').style.color = "#2F3633";
      // Remove blue border if not on np tab
      const npBtn = document.getElementById('np-btn');
      const img = npBtn ? npBtn.querySelector('.np-artwork-img') : null;
      if (img) img.classList.remove('np-artwork-active');
    }
    if (page == "np-header" || page == "np") {
      document.querySelector('#np-btn').style.color = "#396E80";
      document.querySelector('#srch-btn').style.color = "#2F3633";
      const npBtn = document.getElementById('np-btn');
      const img = npBtn ? npBtn.querySelector('.np-artwork-img') : null;
      if (img && img.src && !img.src.endsWith('fallback.svg')) {
        img.classList.add('np-artwork-active');
      }
    }
    if (page == "nap") {
      document.querySelector('#srch-btn').style.color = "#2F3633";
      document.querySelector('#np-btn').style.color = "#2F3633";
      // Remove blue border if not on np tab
      const npBtn = document.getElementById('np-btn');
      const img = npBtn ? npBtn.querySelector('.np-artwork-img') : null;
      if (img) img.classList.remove('np-artwork-active');
    }
  }
  const listenSearch = document.createEvent("CustomEvent");
  const listenOnBoard = document.createEvent("Event");
  const infoScreen = document.createEvent("CustomEvent");
  const nowPlayingEvent = document.createEvent('CustomEvent')
  const pausePlayEvent = document.createEvent('CustomEvent')
  const playLater = document.createEvent('CustomEvent')
  const playNext = document.createEvent('CustomEvent')
  const listenSeeMore = document.createEvent('CustomEvent')
  function getSearch() {
    htmx.ajax('GET', 'search.html', { target: '#content', swap: 'innerHTML', delay: "500ms" })
  }
  document.addEventListener('musickitloaded', async function () {
    try {
      await MusicKit.configure({
        developerToken: 'eyJhbGciOiJFUzI1NiIsImtpZCI6IlFOMjVSSkFEQk4ifQ.eyJpc3MiOiJRN0MyVEMzNlQyIiwiaWF0IjoxNzUzMzAyOTcxLCJleHAiOjE3NTc2MjI5NzEsIm9yaWdpbiI6WyJodHRwczovL3RnLmNvbWljc2VydmVyLm9yZyJdfQ.4xs6J1eRqq1PJktmtyIaPtH_vErmHM6MbxIV4Zs0-mQLoEsPyHhg95UTAiWNoEJagxmwyiBXaqsp7YiaQ5TItQ',
        app: {
          name: 'TuneGram',
          build: '2.1.0',
        },
        debug: true,
        suppressErrorDialog: false
      });
      const music = MusicKit.getInstance();
      const storefront = music.storefrontId || 'us';
      if (!music.isAuthorized) {
        document.querySelector('#np-btn').outerHTML = ""
        document.querySelector('#srch-btn').outerHTML = ""
        document.querySelector('#nameplate').outerHTML = `<div valign="left" id="nameplate" onclick="getSearch()" style="border:none;margin-left:2%;width:100vw">
      <span class="name title-font">TuneGram</span>
      <span class="name title-font" style="font-size:1.5em">Preview</span>
    </div>`
        getSearch()
      }
      document.addEventListener("listenSearch", (e) => {
        searchTerm(e.detail)
      }, false);
      async function searchTerm(term) {
        await music.api.music(`/v1/catalog/${storefront}/search`, { term: term, types: 'albums,songs,playlists' }).then((res) => {
          if (res.data.results) {
            if (res.data.results.songs) {
              var songs = res.data.results.songs.data;
              songs.forEach(searchSongs)
            } else {
              drawSadResults('song');
            }
            if (res.data.results.albums) {
              var albums = res.data.results.albums.data;
              albums.forEach(searchAlbums)
            } else {
              drawSadResults('album');
            }
            if (res.data.results.playlists) {
              var plists = res.data.results.playlists.data;
              plists.forEach(searchPlists)
            } else {
              drawSadResults('plist');
            }
          } else {
            drawSadResults('both');
          }
        }).catch((err) => {
          console.error(err)
        })
      }
      async function infoDo(id) {
        if (id.startsWith('pl')) {
          await music.api.music(`/v1/catalog/${storefront}/playlists/${id}`, queryParameters).then(async (res) => {
            var plist = res.data.data;
            plist.forEach(drawInfo);
            console.log(res);
            await music.api.music(`/v1/catalog/${storefront}/playlists/${id}/tracks`, queryParameters).then((res) => {
              var tracks = res.data.data;
              tracks.forEach(appendTracks);
            }).catch(err => {
              console.log(err);
              if (err) {
                console.error(err);
                ["n/a"].forEach(appendTracks);
              }
            });
          });
        }
        if (id.startsWith('p') && !id.startsWith('pl')) {
          await music.api.music('/v1/me/library/playlists/' + id, queryParameters).then(async (res) => {
            var plist = res.data.data;
            plist.forEach(drawInfo)
            console.log(res)
            await music.api.music(`/v1/me/library/playlists/${id}/tracks`, queryParameters).then((res) => {
              var tracks = res.data.data;
              tracks.forEach(appendTracks)
            }).catch(err => {
              console.log(err)
              if (err) {
                console.error(err)
                ["n/a"].forEach(appendTracks)
              }
            })
          })
        } else if (id.startsWith('s')) {
          var songId = id.slice(1)
          await music.api.music(`/v1/catalog/${storefront}/songs/` + songId, queryParameters).then(async (res) => {
            var albumOfSong = res.data.data[0].relationships.albums.data[0].id
            await music.api.music(`/v1/catalog/${storefront}/albums/` + albumOfSong, queryParameters).then((res) => {
              var album = res.data.data;
              if (album[0].relationships.tracks.data) {
                var tracks = album[0].relationships.tracks.data;
                tracks.forEach(appendTracks)
              }
              album.forEach(drawInfo)
            })
          })
        } else if (id.startsWith('i')) {
          await music.api.music("/v1/me/library/albums/" + id, queryParameters).then(async (res) => {
            var songReportingId = res.data.data[0].attributes.playParams.reportingId;
            await music.api.music(`/v1/catalog/${storefront}/songs/` + songReportingId, queryParameters).then(async (res) => {
              var albumOfSong = res.data.data[0].relationships.albums.data[0].id
              await music.api.music(`/v1/catalog/${storefront}/albums/` + albumOfSong, queryParameters).then((res) => {
                var album = res.data.data;
                if (album[0].relationships.tracks.data) {
                  var tracks = album[0].relationships.tracks.data;
                  tracks.forEach(appendTracks)
                }
                album.forEach(drawInfo)
              })
            });
          })
        } else if (!id.startsWith('p') && !id.startsWith('l') && !id.startsWith('i')) {
          await music.api.music(`/v1/catalog/${storefront}/albums/` + id, queryParameters).then((res) => {
            var album = res.data.data;
            if (album[0].relationships.tracks.data) {
              var tracks = album[0].relationships.tracks.data;
              tracks.forEach(appendTracks)
            }
            album.forEach(drawInfo)
          })
        } else if (id.startsWith('l')) {
          await music.api.music('/v1/me/library/albums/' + id, queryParameters).then((res) => {
            var album = res.data.data;
            if (album[0].relationships.tracks.data) {
              var tracks = album[0].relationships.tracks.data;
              tracks.forEach(appendTracks)
            }
            album.forEach(drawInfo)
          });
        }
      }
      function loadMore(type) {
        methodType = type;
        if (methodType == "heavy") {
          targetPractice = "#heavycards"
        } else if (methodType == "album") {
          targetPractice = "#bigcards"
        } else if (methodType == "playlist") {
          targetPractice = "#smallcards"
        } else if (methodType == "recs") {
          targetPractice = "#rec-cards"
        }
        htmx.ajax('GET', 'seemore.html', { target: targetPractice, swap: 'afterend' })
      }
      document.addEventListener("infoScreen", (e) => {
        infoDo(e.detail)
      }, false);
      if (music.isAuthorized) {
        htmx.ajax('GET', 'onboard.html', { target: '#content', swap: 'innerHTML', delay: "2s" })
        document.body.addEventListener('htmx:afterSwap', function (res) {
          var resUlt = res.detail.requestConfig.path;
          if (resUlt.includes("np.html")) {
            if (music.playbackState == 2) {
              document.getElementById('plpa-btn').innerHTML = "pause"
            } else if (music.playbackState == 3) {
              document.getElementById('plpa-btn').innerHTML = "play_arrow"
            }
          }
        })
        document.addEventListener("listenSeeMore", async (e) => {
          seeMore();
        })
        async function seeMore() {
          var rawMethod = methodType;
          var chosenFunc = "";
          var methodUrl = ""
          var offSet = document.querySelector(targetPractice).children.length + 1;
          if (rawMethod == "heavy") {
            methodUrl = "/v1/me/history/heavy-rotation";
            chosenFunc = drawHeavy;
          } else if (rawMethod == "album") {
            methodUrl = "/v1/me/library/albums";
            chosenFunc = drawAlbums;
          } else if (rawMethod == "playlist") {
            methodUrl = "/v1/me/library/playlists";
            chosenFunc = drawPlists;
          }
          const greaterAlbums = await music.api.music(methodUrl, { offset: offSet }).then((data) => {
            if (data.data) {
              var res = data.data.data;
              if (res.length == 0) {
                $(targetPractice + ' card').last()[0].scrollIntoView({
                  behavior: "smooth",
                  block: "start",
                  block: 'nearest',
                  inline: 'center'
                });
              } else {
                $(targetPractice + ' card').last()[0].scrollIntoView({
                  behavior: "smooth",
                  block: "start",
                  block: 'nearest',
                  inline: 'center'
                });
                res.forEach(chosenFunc)
              }
            }
          });
        }
        document.addEventListener("listenOnBoard", (e) => {
          document.getElementById("mix-more").addEventListener("click", function () {
            loadMore('playlist')
          });
          document.getElementById("alb-more").addEventListener("click", function () {
            loadMore('album')
          });
          document.getElementById("hvy-more").addEventListener("click", function () {
            loadMore('heavy')
          });
          loadLibrary()
        }, false);
        document.addEventListener("pausePlayEvent", async (e) => {
          var typee = e.detail
          var type = typee.slice(0, 2);
          var id = typee.slice(2)
          if (type == "re") {
            await music.skipToPreviousItem()
          } else if (type == "ff") {
            await music.skipToNextItem()
          } else {
            if (music.isPlaying == true) {
              music.pause()

            } else {
              music.play();

            }
          }
        }, false);
        document.addEventListener("nowPlayingEvent", async (e) => {
          loadVisuals(queue, e.detail)
          var songId = [e.detail];
          if (e.detail !== "") {
            if (e.detail !== "viewonly") {
              await music.setQueue({ songs: songId, startPlaying: true })
              loadVisuals(music.queue.items, e.detail)
            } else {
              if (music.queue.currentItem) {
                loadVisuals(music.queue.items, music.queue.currentItem.id);
                (music.queue.items).forEach(appendTracks)
                loadLyrics()
                updateHighlightedTrack();
              } else {
                ["n/a"].forEach(appendTracks)
              }
            }
          }
        }, false);
      }
      document.addEventListener("playLater", async (e) => {
        if ((music.queue.items).length == 0) {
          queue = await music.setQueue({ songs: [e.detail], startPlaying: true });
          loadVisuals(queue, e.detail)
        } else {
          music.playLater({ songs: [e.detail] })
          queue = music.queue.items;
        }
      }, false);
      document.addEventListener("playNext", async (e) => {
        if ((music.queue.items).length == 0) {
          queue = await music.setQueue({ songs: [e.detail], startPlaying: true });
          loadVisuals(queue, e.detail)
        } else {
          music.playNext({ songs: [e.detail] })
          queue = music.queue.items;
        }
      }, false);
      music.addEventListener('nowPlayingItemDidChange', ({ item }) => {
        if (item !== undefined) {
          let artworkUrl = '';
          if (item.attributes && item.attributes.artwork) {
            artworkUrl = MusicKit.formatArtworkURL(item.attributes.artwork, 96, 96);
          }
          updateNpBtnArtwork(artworkUrl);
          loadVisuals(queue, item.id)
          updateHighlightedTrack();
          loadLyrics()
        }
      });
      music.addEventListener('queueItemsDidChange', ({ item }) => {
        const queue = music.queue.items;
        queue.forEach(appendTracks)
        loadVisuals(queue, music.queue.currentItem)
        updateHighlightedTrack();
      });
      function loadVisuals(queue, id) {
        var songPlaying = music.queue.currentItem;
        if (songPlaying !== undefined) {
          var queueItems = music.queue.items;
          hiItsQue = true;
          var root = songPlaying.attributes;
          var art = "";
          var bgColor = "#396E80";
          if (root.artwork) {
            if (root.artwork.url) {
              art = MusicKit.formatArtworkURL(root.artwork, 500, 500);
              getImageColors(art).then(({ bgColor, contrastColor }) => {
                bgColor = bgColor || "#396E80";
                document.querySelector('#np #info-img').style.border = `3px solid ${bgColor}`;
              });
            }
          } else {
            art = "fallback.svg"
          }
          var detailSubheading = "";
          var finalName = "";
          var finalAlbumName = "";
          var name = (root.name).toLowerCase();
          var albumName = (root.albumName).toLowerCase();
          if (name.includes('(') || name.includes('[')) {
            var detailSub = "";
            if (name.includes('(') && (tags.some(tag => name.includes(tag)) || /\b(19|20)\d{2}\b/.test(name))) {
              detailSub = (root.name).split('(')[1].split(')')[0];
              finalName = (root.name).split('(')[0].split('[')[0].trim();
              detailSubheading = `<detail-subheading><detail-label>${detailSub}</detail-label></detail-subheading>`;
            } else if (name.includes('[') && (tags.some(tag => name.includes(tag)) || /\b(19|20)\d{2}\b/.test(name))) {
              detailSub = (root.name).split('[')[1].split(']')[0];
              finalName = (root.name).split('(')[0].split('[')[0].trim();
              detailSubheading = `<detail-subheading><detail-label>${detailSub}</detail-label></detail-subheading>`;
            }
          } else {
            finalName = root.name;
            finalAlbumName = root.albumName;
          }
          if (albumName.includes('(') || albumName.includes('[')) {
            console.log('Found a parenthesis or bracket in the album name: ' + name);
            finalAlbumName = (root.albumName).split('(')[0].split('[')[0].trim();
          }
          document.querySelector('#np #plpa-btn').setAttribute('onclick', `pausePlay('${id}', 'pp')`)
          document.querySelector('#np #rewind-btn').setAttribute('onclick', `pausePlay('na', 're')`)
          document.querySelector('#np #ff-btn').setAttribute('onclick', `pausePlay('na', 'ff')`)
          document.querySelector('#info-wrapper-np #info-title').innerHTML = finalName
          document.querySelector('#info-wrapper-np #info-artist').innerHTML = root.artistName
          document.querySelector('#info-wrapper-np #info-album').innerHTML = finalAlbumName
          document.querySelector('#np #info-img').src = art
          document.querySelector('#info-wrapper-np #info-details').innerHTML = detailSubheading;
        } else {
          document.querySelector('#info-wrapper-np #info-title').innerHTML = 'Not Playing';
          document.querySelector('#info-wrapper-np #info-artist').innerHTML = '';
          document.querySelector('#info-wrapper-np #info-album').innerHTML = '';
          document.querySelector('#np #info-img').src = 'fallback.svg';
        }
      }
      function converter(millis) {
        var minutes = Math.floor(millis / 60000);
        var seconds = ((millis % 60000) / 1000).toFixed(0);
        return minutes + ":" + (seconds < 10 ? '0' : '') + seconds;
      }
      function appendTracks(item, index, array) {
        if (item === "n/a") {
          console.warn('No appendable tracks to Queue or Tracklist.');
          document.getElementById('infobox').classList.remove('skeleton-page');
        } else {
          tracksToCount = array.length;
          var title = item.attributes.name
          var runtime = item.attributes.durationInMillis;
          var id;
          if (music.isAuthorized) {
            id = item.id
          } else {
            id = "prev+" + item.attributes.previews[0].url
          }
          var art = ""
          if (item.attributes.artwork) {
            art = MusicKit.formatArtworkURL(item.attributes.artwork, 25, 25);
          } else {
            art = "fallback.svg"
          }
          var idIcon = "play_arrow";
          var html = ` <tr>
            <td class="material-symbols-outlined general-music-control" onclick="musicPlay('${id}', '${art}')">${idIcon}</td>
            <td class="song-title">${title}</td>
            <td>${converter(runtime)}</td>`
          queuecontrols: if (music.isAuthorized) {
            if (document.querySelector("#np")) {
              if (((document.querySelector("#np").parentElement).parentElement).getAttribute("id") !== "np-container") {
                document.getElementById('tracklist').innerHTML = `
  <th class="labels">Play</th>
  <th class="labels">Name</th>
  <th class="labels">Runtime</th>`
                break queuecontrols;
              }
            }
            document.getElementById('tracklist').innerHTML = `
  <th class="labels">Play</th>
  <th class="labels">Name</th>
  <th class="labels">Runtime</th>
  <th class="labels">Queue</th>`
            html += `<td class="material-symbols-outlined general-music-control" onclick="playNextOrLast('${id}', 'next')">queue_play_next</td>
            <td class="material-symbols-outlined general-music-control" onclick="playNextOrLast('${id}', 'later')">add_to_queue</td>
            </tr>`
          } else {
            html += "</tr>"
          }
          if (hiItsQue == true) {
            hiItsQue = false;
            // Potential for queue specialness in Now Playing view
          }
          tracksProcessed++
          toDrawTracks += html
          if (tracksProcessed == tracksToCount && tracksProcessed !== 0) {
            document.querySelector('#tracklist').innerHTML += toDrawTracks;
            if (document.querySelectorAll('.queue-trklst tr').length > 1) {
              updateHighlightedTrack()
            }
            tracksProcessed = 0;
            toDrawTracks = "";
            document.getElementById('infobox').classList.remove('skeleton-page')
          }
        }
      }
      function loadLyrics() {
        var songName = music.queue.currentItem ? music.queue.currentItem.attributes.name : '';
        var artistName = music.queue.currentItem ? music.queue.currentItem.attributes.artistName : '';
        var albumName = music.queue.currentItem ? music.queue.currentItem.attributes.albumName : '';
        var dur = music.queue.currentItem ? music.queue.currentItem.attributes.durationInMillis : '';
        if (songName && artistName && albumName && dur) {
          var duration = dur / 1000;
          document.querySelector('#lyrics').innerHTML = '<p>Loading lyrics...</p>';
          const cover = document.querySelector('#np #info-img').src;
          getImageColors(cover).then(({ bgColor, contrastColor }) => {
            var lightContrast = contrastColor.replace(/rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,\s*[\d.]+)?\)/, (match, r, g, b) => `rgba(${r}, ${g}, ${b}, 0.5)`);
            bgColor = bgColor || "#396E80";
            contrastColor = contrastColor || "#E3E1DB";
            document.querySelector('#lyrics').style.backgroundColor = bgColor;
            document.querySelector('#lyrics').style.color = contrastColor;
            const sheet = document.styleSheets[0];
            for (let i = sheet.cssRules.length - 1; i >= 0; i--) {
              if (sheet.cssRules[i].selectorText === '.lyric-line' ||
                sheet.cssRules[i].selectorText === '.lyric-line.highlight') {
                sheet.deleteRule(i);
              }
            }
            document.styleSheets[0].insertRule(`.lyric-line { color: ${lightContrast} !important; margin-top: 1%; margin-bottom: 1%; font-size: 2em; cursor: pointer; }`, 0);
            document.styleSheets[0].insertRule(`.lyric-line.highlight { color: ${contrastColor} !important; }`, 0);
          });
          fetch(`https://lrclib.net/api/get?artist_name=${encodeURIComponent(artistName)}&track_name=${encodeURIComponent(songName)}`)
            .then(response => response.json())
            .then(data => {
              if (data.instrumental == false && (data.plainLyrics || data.syncedLyrics)) {
                if (data.syncedLyrics) {
                  const lyricsArray = data.syncedLyrics.split('\n').map(line => {
                    const match = line.match(/^\[(\d{2}:\d{2}\.\d{2})\]\s*(.*)$/);
                    return match ? { time: match[1], text: match[2] } : null;
                  }).filter(Boolean);
                  var lyricsHtml = lyricsArray.map(line => {
                    if (line.text === "") {
                      return `<p class=\"lyric-line lyric-break\" data-time=\"${line.time}\"><span class=\"material-symbols-outlined lyric-break-note" style=\"font-size:1.2em;vertical-align:middle;opacity:0.5;transition:filter 0.2s,opacity 0.2s;\">music_note</span></p>`;
                    } else {
                      return `<p class=\"lyric-line\" data-time=\"${line.time}\">${line.text}</p>`;
                    }
                  }).join('<br>');
                  document.querySelector('#lyrics').innerHTML = lyricsHtml;
                  const css = `@media (max-width: 650px) { #lyrics { width: fit-content !important; } }`;
                  document.styleSheets[0].insertRule(css, 0);
                  const lyricLines = document.querySelectorAll('.lyric-line');
                  let lastHighlighted = -1;
                  let scrollLock = false;
                  let scrollLockTimeout = null;
                  let pulseFrame = null;

                  const lyricsDiv = document.getElementById('lyrics');
                  if (lyricsDiv) {
                    lyricsDiv.addEventListener('wheel', function () {
                      scrollLock = true;
                      if (scrollLockTimeout) clearTimeout(scrollLockTimeout);
                      scrollLockTimeout = setTimeout(() => {
                        scrollLock = false;
                      }, 5000);
                    }, { passive: true });
                  }

                  lyricLines.forEach((line, idx) => {
                    line.addEventListener('click', function (e) {
                      const t = line.getAttribute('data-time');
                      if (t) {
                        const [min, sec] = t.split(':');
                        const time = parseInt(min) * 60 + parseFloat(sec);
                        if (music && typeof music.seekToTime === 'function') {
                          music.seekToTime(time);
                        } else if (music && music.player && typeof music.player.seekToTime === 'function') {
                          music.player.seekToTime(time);
                        }
                      }
                    });
                  });

                  function parseTime(timeStr) {
                    if (!timeStr) return NaN;
                    const [min, sec] = timeStr.split(':');
                    if (!min || !sec) return NaN;
                    return (parseInt(min) * 60 + parseFloat(sec)) * 1000;
                  }

                  let lastBreakIdx = -1;
                  let glowAnimationFrame = null;

                  function stopPulse() {
                    if (glowAnimationFrame) cancelAnimationFrame(glowAnimationFrame);
                    document.querySelectorAll('.lyric-break-note').forEach(note => {
                      note.style.opacity = 0.5;
                      note.style.filter = 'brightness(1)';
                    });
                  }

                  var audio = document.querySelector('audio');
                  var now = audio.currentTime * 1000;

                  if (audio) {
                    audio.addEventListener('timeupdate', function () {
                      now = audio.currentTime * 1000;
                      window.now = now;
                    });
                  }


                  if (!Object.getOwnPropertyDescriptor(window, 'now')) {
                    let _now = 0;
                    Object.defineProperty(window, 'now', {
                      get() { return _now; },
                      set(value) {
                        _now = value;
                        window.dispatchEvent(new CustomEvent('nowChanged', { detail: { now: value } }));
                      }
                    });
                  }

                  window.addEventListener('nowChanged', function (e) {
                    highlightCurrentLine();
                  });

                  function animateGlow(note, breakStart, breakEnd) {
                    function step() {
                      console.log(now, breakStart, breakEnd);
                      if (now < breakStart || now > breakEnd) {
                        note.style.opacity = 0.5;
                        note.style.filter = 'brightness(1)';
                        return;
                      }
                      const progress = Math.max(0, Math.min(1, (now - breakStart) / (breakEnd - breakStart)));
                      note.style.opacity = 0.5 + 0.5 * progress;
                      note.style.filter = `brightness(${1 + progress})`;
                      if (progress < 1 && now < breakEnd) {
                        glowAnimationFrame = requestAnimationFrame(step);
                      }
                    }
                    step();
                  }

                  function highlightCurrentLine() {
                    const EPSILON = 60; // milliseconds of leniency (adjust as needed)
                    const currentTime = now;
                    let highlightIndex = -1;
                    let breakIdx = -1, breakStart = null, breakEnd = null;

                    for (let i = 0; i < lyricLines.length; i++) {
                      const lineTime = lyricLines[i].getAttribute('data-time');
                      const lineText = lyricLines[i].classList.contains('lyric-break') ? '' : lyricLines[i].innerHTML.trim();
                      const thisTime = parseTime(lineTime);

                      // Allow for leniency: treat as "reached" if within EPSILON ms
                      if (!isNaN(thisTime) && currentTime + EPSILON >= thisTime) {
                        if (lineText === '') {
                          breakIdx = i;
                          breakStart = thisTime;
                          breakEnd = (i + 1 < lyricLines.length) ? parseTime(lyricLines[i + 1].getAttribute('data-time')) : Infinity;
                        } else {
                          highlightIndex = i;
                        }
                      }
                    }

                    lyricLines.forEach(line => line.classList.remove('highlight'));

                    if (breakIdx !== -1) {
                      lyricLines[breakIdx].classList.add('highlight');
                      if (breakIdx !== lastBreakIdx) {
                        stopPulse();
                        const note = lyricLines[breakIdx].querySelector('.lyric-break-note');
                        if (note) animateGlow(note, breakStart, breakEnd);
                        lastBreakIdx = breakIdx;
                      }
                    } else {
                      if (lastBreakIdx !== -1) stopPulse();
                      lastBreakIdx = -1;
                    }

                    if (highlightIndex !== -1) {
                      lyricLines[highlightIndex].classList.add('highlight');
                      lastHighlighted = highlightIndex;
                      if (!scrollLock) {
                        const lyricsDiv = document.querySelector("#lyrics");
                        const target = lyricLines[highlightIndex];
                        scrollParentToChild(lyricsDiv, target);
                      }
                    } else if (breakIdx !== -1 && !scrollLock) {
                      // Scroll to the next line after the lyric break
                      const lyricsDiv = document.querySelector("#lyrics");
                      const nextLine = lyricLines[breakIdx + 1];
                      if (nextLine) {
                        scrollParentToChild(lyricsDiv, nextLine);
                      }
                    }
                  }

                  highlightCurrentLine();
                } else if (data.plainLyrics) {
                  var plainLyrics = data.plainLyrics.replace(/\n/g, "<br>");
                  document.querySelector('#lyrics').innerHTML = plainLyrics;
                }
              } else if (data.instrumental == true) {
                document.querySelector('#lyrics').innerText = 'Instrumental';
              } else {
                document.querySelector('#lyrics').innerText = 'Lyrics not found.';
              }
            })
        } else {
          document.querySelector('#lyrics').innerText = 'No song playing.';
        }
      }
      function scrollParentToChild(parent, child) {
        if (!parent || !child) return;
        const parentRect = parent.getBoundingClientRect();
        const childRect = child.getBoundingClientRect();
        const offset = childRect.top - parentRect.top;
        const scroll = parent.scrollTop;
        const targetScroll = scroll + offset - (parent.clientHeight / 2) + (child.clientHeight / 2);
        const maxScroll = parent.scrollHeight - parent.clientHeight;
        const finalScroll = Math.max(0, Math.min(targetScroll, maxScroll));
        parent.scrollTo({ top: finalScroll, behavior: 'smooth' });
      }

      function updateHighlightedTrack() {
        if (queue && music.queue.position !== undefined) {
          document.querySelectorAll('.queue-trklst tr').forEach(tr => tr.classList.remove('playing'));
          document.querySelectorAll('.queue-trklst tr')[music.queue.position + 1].classList.add('playing');
        }
      }
      function drawInfo(item, index, array) {
        var fullDate = item.attributes.releaseDate;
        var cover = "fallback.svg";
        var sub = ""
        var subsub = ""
        if (item.attributes.artwork) {
          if (item.attributes.artwork.url) {
            cover = MusicKit.formatArtworkURL(item.attributes.artwork, 500, 500);
            getImageColors(cover).then(({ bgColor, contrastColor }) => {
              bgColor = bgColor || "#396E80";
              if (document.querySelector("#np")) {
                document.querySelector('#np #info-img').style.border = `3px solid ${bgColor}`;
              }
              document.querySelector('#info #info-img').style.border = `3px solid ${bgColor}`;
            });
          }
        } else {
          cover = "fallback.svg"
        }
        if (item.attributes.artistName) {
          sub = item.attributes.artistName;
        }
        if (item.attributes.releaseDate) {
          var dt = new Date(item.attributes.releaseDate);
          subsub = dt.getFullYear();
        }
        var detailSubheading = "";
        var name = (item.attributes.name).toLowerCase();
        if (name.includes('(') || name.includes('[')) {
          console.log('Found a parenthesis or bracket in the album name: ' + name);
          var detailSub = "";
          if (name.includes('(') && (tags.some(tag => name.includes(tag)) || /\b(19|20)\d{2}\b/.test(name))) {
            detailSub = (item.attributes.name).split('(')[1].split(')')[0];
          } else if (name.includes('[') && (tags.some(tag => name.includes(tag)) || /\b(19|20)\d{2}\b/.test(name))) {
            detailSub = (item.attributes.name).split('[')[1].split(']')[0];
          }
          item.attributes.name = (item.attributes.name).split('(')[0].split('[')[0].trim();
          detailSubheading = `<detail-subheading><detail-label>${detailSub}</detail-label></detail-subheading>`;
        }
        document.querySelector('#info-title').innerHTML = item.attributes.name;
        document.querySelector('#info-year').innerHTML = subsub;
        document.querySelector('#info-artist').innerHTML = sub;
        document.querySelector('#info #info-img').src = cover;
        document.querySelector("#info-details").innerHTML = detailSubheading;
        document.querySelector("#play-all").setAttribute('onclick', `playAll('${item.id}')`);
        document.querySelector("#shuffle-all").setAttribute('onclick', `shuffleAll('${item.id}')`);
      }
      async function loadLibrary() {
        if (!sessionStorage.getItem('plistStorage') || !sessionStorage.getItem('albumStorage') || !sessionStorage.getItem('heavyStorage') || !sessionStorage.getItem('recStorage')) {
          const greaterAlbums = await music.api.music('/v1/me/library/albums').then((data) => {
            if (data.data) {
              var albums = data.data.data
              albums.forEach(drawAlbums)
            }
          });
          await music.api.music('/v1/me/history/heavy-rotation').then((data) => {
            var heavyRotation = data.data.data;
            heavyRotation.forEach(drawHeavy)
          });
          const plists = await music.api.music('/v1/me/library/playlists').then(async (data) => {
            var plists = data.data.data
            plists.forEach(drawPlists)
          })
          const recs = await music.api.music('/v1/me/recommendations').then(async (data) => {
            var parentData = data.data.data
            var num = Math.random() * parentData.length | 0
            var recs = parentData[num].relationships.contents.data;
            var attrs = parentData[num].attributes.title.stringForDisplay;
            recs.forEach(drawRecs)
            document.querySelector("#rec-heading").innerHTML = attrs;
            sessionStorage.setItem("rec-heading-innerhtml", document.querySelector("#rec-heading").innerHTML);
          })
        } else {
          drawBoth()
        }
      }
      music.addEventListener('playbackStateDidChange', ({ oldState, state }) => {
        if (state == "10") {
          loadContent('onboard');
          htmx.ajax('GET', 'onboard.html', { target: '#content', swap: 'innerHTML' });
        }
        if (state == 2) {
          document.getElementById('plpa-btn').innerHTML = "pause"
        } else if (state == 3) {
          document.getElementById('plpa-btn').innerHTML = "play_arrow"
        }
      });

      window.shuffleAll = async function (id) {
        let isLibrary = (id.startsWith('p') && !id.startsWith('pl')) || id.startsWith('i');
        let isPlaylist = id.startsWith('pl') || (isLibrary && id.startsWith('p'));
        let isAlbum = !isPlaylist && (id.startsWith('a') || id.startsWith('i')) || /^\d/.test(id);
        let albumApiUrl = isAlbum ? `/v1/catalog/${storefront}/albums/${id}` : `/v1/me/library/albums/${id}`;
        let playlistApiUrl = isPlaylist ? `/v1/catalog/${storefront}/playlists/${id}` : `/v1/me/library/playlists/${id}`;
        let apiUrl = isPlaylist ? playlistApiUrl : albumApiUrl;
        let albumRes = await music.api.music(apiUrl, { l: 'en-us' });
        let albumData = albumRes?.data?.data?.[0];
        if (!albumData || !albumData.relationships || !albumData.relationships.tracks || !albumData.relationships.tracks.data) return;
        let tracks = albumData.relationships.tracks.data;
        let ids = [];
        for (let track of tracks) {
          if (track.attributes?.playParams?.reportingId) {
            ids.push(track.attributes.playParams.reportingId);
          } else if (track.id) {
            ids.push(track.id);
          }
        }
        ids = ids.filter(Boolean);
        if (!ids.length) return;
        loadContent('np');
        htmx.ajax('GET', 'np.html?id=', { target: '#content', swap: 'innerHTML', delay: "500ms" });
        const shufIds = [...ids].sort(() => Math.random() - 0.5);
        await music.setQueue({ songs: shufIds, startPlaying: true });
        queue = music.queue.items;
      }

      window.playAll = async function (id) {
        let isLibrary = (id.startsWith('p') && !id.startsWith('pl')) || id.startsWith('i');
        let isPlaylist = id.startsWith('pl') || (isLibrary && id.startsWith('p'));
        let isAlbum = !isPlaylist && (id.startsWith('a') || id.startsWith('i')) || /^\d/.test(id);
        let albumApiUrl = isAlbum ? `/v1/catalog/${storefront}/albums/${id}` : `/v1/me/library/albums/${id}`;
        let playlistApiUrl = isPlaylist ? `/v1/catalog/${storefront}/playlists/${id}` : `/v1/me/library/playlists/${id}`;
        let apiUrl = isPlaylist ? playlistApiUrl : albumApiUrl;
        let albumRes = await music.api.music(apiUrl, { l: 'en-us' });
        let albumData = albumRes?.data?.data?.[0];
        if (!albumData || !albumData.relationships || !albumData.relationships.tracks || !albumData.relationships.tracks.data) return;
        let tracks = albumData.relationships.tracks.data;
        let ids = [];
        for (let track of tracks) {
          if (track.attributes?.playParams?.reportingId) {
            ids.push(track.attributes.playParams.reportingId);
          } else if (track.id) {
            ids.push(track.id);
          }
        }
        ids = ids.filter(Boolean);
        if (!ids.length) return;
        loadContent('np');
        htmx.ajax('GET', 'np.html?id=', { target: '#content', swap: 'innerHTML', delay: "500ms" });
        await music.setQueue({ songs: ids, startPlaying: true });
        queue = music.queue.items;
      }

    } catch (err) {
      console.error(err)
    }
  });
  document.querySelectorAll('#content')[0].style.display = "block";
  function drawRecs(item, index, array) {
    recsToCount = array.length;
    var cover = "";
    if (item.attributes.artwork) {
      cover = MusicKit.formatArtworkURL(item.attributes.artwork, 500, 500);
    } else if (!item.attributes.artwork && item.attributes.artistName) {
      return;
    }
    var subheading = "";
    if (item.attributes.artistName) {
      subheading = item.attributes.artistName;
    } else {
      var date = new Date(item.attributes.lastModifiedDate);
      var edited = (date.getMonth() + 1) + "/" + date.getDate() + "/" + date.getFullYear()
      subheading = `Edited: ${edited}`;
    }
    var card = `<card onclick="toAlbum('${item.id}')"><img src="${cover}"/><heading>${item.attributes.name}</heading><subheading>${subheading}</subheading></card>`
    recsProcessed++
    toDrawRecs += card
    if (recsProcessed == recsToCount && recsProcessed !== 0) {
      document.querySelector('#rec-cards').innerHTML += toDrawRecs
      var setStorageStr = toDrawRecs;
      if (sessionStorage.getItem('recStorage')) {
        setStorageStr = sessionStorage.getItem('recStorage') + toDrawRecs;
      }
      sessionStorage.setItem('recStorage', setStorageStr)
    }
  }
  function drawAlbums(item, index, array) {
    albumsToCount = array.length
    if (item.attributes.url) {
      item.id = item.attributes.url.split('/').pop();
    }
    if (!item.attributes.artwork) {
      albumsProcessed++
      return;
    }
    var name = (item.attributes.name).toLowerCase();
    if (item.attributes.name === undefined) {
      item.attributes.name = "Unknown Album";
    }
    var detailSubheading = "";
    if (name.includes('(') || name.includes('[')) {
      console.log('Found a parenthesis or bracket in the album name: ' + name);
      var detailSub = "";
      if (name.includes('(') && (tags.some(tag => name.includes(tag)) || /\b(19|20)\d{2}\b/.test(name))) {
        detailSub = (item.attributes.name).split('(')[1].split(')')[0];
      } else if (name.includes('[') && (tags.some(tag => name.includes(tag)) || /\b(19|20)\d{2}\b/.test(name))) {
        detailSub = (item.attributes.name).split('[')[1].split(']')[0];
      }
      item.attributes.name = (item.attributes.name).split('(')[0].split('[')[0].trim();
      detailSubheading = `<detail-subheading><detail-label>${detailSub}</detail-label></detail-subheading>`;
    }
    if (item.attributes.artistName === undefined) {
      item.attributes.artistName = "Unknown Artist";
    }
    if (item.attributes.releaseDate === undefined) {
      item.attributes.releaseDate = "Unknown Release Date";
    }
    if (item.attributes.playParams === undefined) {
      item.attributes.playParams = {
        reportingId: item.id
      }
    }
    var cover = MusicKit.formatArtworkURL(item.attributes.artwork, 500, 500);
    var card = `<card onclick="toAlbum('${item.id}')"><img src="${cover}"/><heading>${item.attributes.name}</heading><subheading>${item.attributes.artistName}</subheading>${detailSubheading}</card>`
    albumsProcessed++
    toDrawAlbums += card
    if (albumsProcessed == albumsToCount && albumsProcessed !== 0) {
      document.querySelector('#bigcards').innerHTML += toDrawAlbums;
      var setStorageStr = toDrawAlbums;
      if (sessionStorage.getItem('albumStorage')) {
        setStorageStr = sessionStorage.getItem('albumStorage') + toDrawAlbums;
      }
      sessionStorage.setItem('albumStorage', setStorageStr)
    }
  }
  function drawHeavy(item, index, array) {
    heavyProcessed++
    if (item.attributes) {
      heavyToCount = array.length
      var cover = "";
      if (item.attributes.artwork) {
        cover = MusicKit.formatArtworkURL(item.attributes.artwork, 500, 500);
      } else if (!item.attributes.artwork && item.attributes.artistName) {
        return;
      }
      var subheading = "";
      if (item.attributes.artistName) {
        subheading = item.attributes.artistName;
      } else {
        var date = new Date(item.attributes.lastModifiedDate);
        var edited = (date.getMonth() + 1) + "/" + date.getDate() + "/" + date.getFullYear()
        subheading = `Edited: ${edited}`;
      }
      var card = `<card onclick="toAlbum('${item.id}')"><img src="${cover}"/><heading>${item.attributes.name}</heading><subheading>${subheading}</subheading></card>`
      toDrawHeavy += card
      if (heavyProcessed == heavyToCount && heavyProcessed !== 0) {
        document.querySelector('#heavycards').innerHTML += toDrawHeavy
        var setStorageStr = toDrawHeavy;
        if (sessionStorage.getItem('heavyStorage')) {
          setStorageStr = sessionStorage.getItem('heavyStorage') + toDrawHeavy;
        }
        sessionStorage.setItem('heavyStorage', setStorageStr)
      }
    } else {
      console.warn('Couldn\'t append an item in Heavy Rotation. Likely a station.')
      if (heavyProcessed == heavyToCount && heavyProcessed !== 0) {
        document.querySelector('#heavycards').innerHTML += toDrawHeavy
        var setStorageStr = toDrawHeavy;
        if (sessionStorage.getItem('heavyStorage')) {
          setStorageStr = sessionStorage.getItem('heavyStorage') + toDrawHeavy;
        }
        sessionStorage.setItem('heavyStorage', setStorageStr)
      }
    }
  }
  function drawSadResults(type) {
    if (type == "album") {
      document.querySelector('#bigcards').remove()
      document.querySelector('#albums-results').remove()
    }
    if (type == "song") {
      document.querySelector('#songcards').remove()
      document.querySelector('#songs-results').remove()
    }
    if (type == "plist") {
      document.querySelector('#plistcards').remove()
      document.querySelector('#plist-results').remove()
    }
    if (type == "both") {
      document.querySelector('#bigcards').remove()
      document.querySelector('#songcards').remove()
      document.querySelector('#albums-results').remove()
      document.querySelector('#songs-results').remove()
    }
  }
  function searchAlbums(item, index, array) {
    albumsToCount = array.length
    var cover = MusicKit.formatArtworkURL(item.attributes.artwork, 500, 500);
    var name = (item.attributes.name).toLowerCase();
    console.log('Processing album: ' + name);
    var detailSubheading = "";
    if (name.includes('(') || name.includes('[')) {
      console.log('Found a parenthesis or bracket in the album name: ' + name);
      var detailSub = "";
      if (name.includes('(') && (tags.some(tag => name.includes(tag)) || /\b(19|20)\d{2}\b/.test(name))) {
        detailSub = (item.attributes.name).split('(')[1].split(')')[0];
      } else if (name.includes('[') && (tags.some(tag => name.includes(tag)) || /\b(19|20)\d{2}\b/.test(name))) {
        detailSub = (item.attributes.name).split('[')[1].split(']')[0];
      }
      item.attributes.name = (item.attributes.name).split('(')[0].split('[')[0].trim();
      detailSubheading = `<detail-subheading><detail-label>${detailSub}</detail-label></detail-subheading>`;
    }
    var card = `<card onclick="toAlbum('${item.id}')"><img src="${cover}"/><heading>${item.attributes.name}</heading><subheading>${item.attributes.artistName}</subheading>${detailSubheading}</card>`
    albumsProcessed++
    toDrawAlbums += card
    if (albumsProcessed == albumsToCount && albumsProcessed !== 0) {
      document.querySelector('#bigcards').innerHTML = toDrawAlbums
    }
  }
  function searchPlists(item, index, array) {
    plistsToCount = array.length
    var cover = MusicKit.formatArtworkURL(item.attributes.artwork, 1000, 1000);
    console.log(cover)
    getImageColors(cover).then(({ bgColor, contrastColor }) => {
      var date = new Date(item.attributes.lastModifiedDate);
      edited = (date.getMonth() + 1) + "/" + date.getDate() + "/" + date.getFullYear()
      var card = `<card onclick="toAlbum('${item.id}')"><img src="${cover}"/><heading>${item.attributes.name}</heading><subheading>Edited ${edited}</subheading></card>`
      plistsProcessed++
      toDrawPlists += card
      if (plistsProcessed == plistsToCount && plistsProcessed !== 0) {
        document.querySelector('#plistcards').innerHTML = toDrawPlists;
        plistsProcessed = 0;
        toDrawPlists = ""
      }
    }).catch((err) => {
      console.error('Error getting background color:', err);
    });
  }

  function searchSongs(item, index, array) {
    songsToCount = array.length
    var cover = MusicKit.formatArtworkURL(item.attributes.artwork, 1000, 1000);
    console.log(cover)
    getImageColors(cover).then(({ bgColor, contrastColor }) => {
      var card = `<card style="background-color:${bgColor};" onclick="toAlbum('s${item.id}')"><img src="${cover}"/><heading style="color:${contrastColor}">${item.attributes.name}</heading><subheading style="color:${contrastColor}">${item.attributes.artistName}</subheading></card>`
      songsProcessed++
      toDrawSongs += card
      if (songsProcessed == songsToCount && songsProcessed !== 0) {
        document.querySelector('#songcards').innerHTML = toDrawSongs;
        songsProcessed = 0;
        toDrawSongs = ""
      }
    }).catch((err) => {
      console.error('Error getting background color:', err);
    });
  }
  function drawBoth() {
    document.querySelector('#bigcards').innerHTML = sessionStorage.getItem('albumStorage')
    document.querySelector('#heavycards').innerHTML = sessionStorage.getItem('heavyStorage')
    document.querySelector('#smallcards').innerHTML = sessionStorage.getItem('plistStorage')
    document.querySelector('#rec-cards').innerHTML = sessionStorage.getItem('recStorage')
    document.querySelector("#rec-heading").innerHTML = sessionStorage.getItem("rec-heading-innerhtml");
  }
  function drawPlists(item, index, array) {
    plistsToCount = array.length
    var cover = "fallback.svg"
    if (item.attributes.artwork) {
      cover = MusicKit.formatArtworkURL(item.attributes.artwork, 500, 500)
    }
    if (item.attributes.name === undefined) {
      item.attributes.name = "Unknown Playlist";
    }
    if (item.attributes.playParams === undefined) {
      item.attributes.playParams = {
        reportingId: item.id
      }
    }
    var edited = "";
    if (item.attributes.lastModifiedDate === "1970-01-01T00:00:00Z") {
      edited = "Date Unknown";
    } else {
      var date = new Date(item.attributes.lastModifiedDate);
      edited = (date.getMonth() + 1) + "/" + date.getDate() + "/" + date.getFullYear()
    }
    var card = `<card onclick="toAlbum('${item.id}')"><img src="${cover}"/><heading>${item.attributes.name}</heading><subheading>Edited ${edited}</subheading></card>`
    plistsProcessed++
    toDrawPlists += card
    if (plistsProcessed == plistsToCount && plistsProcessed !== 0) {
      document.querySelector('#smallcards').innerHTML += toDrawPlists
      var setStorageStr = toDrawPlists;
      if (sessionStorage.getItem('plistStorage')) {
        setStorageStr = sessionStorage.getItem('plistStorage') + toDrawPlists;
      }
      sessionStorage.setItem('plistStorage', setStorageStr)
    }
  }
  var infoId = ""
  var npId = ""
  var searchId = ""
  function toAlbum(id) {
    infoId = id
    htmx.ajax('GET', 'info.html?id=' + id, { target: '#content', swap: 'innerHTML', delay: "500ms" })
  }
  function musicPlay(id, art) {
    npId = id;
    if (!id.startsWith('prev+')) {
      if (id !== "itunesonly") {
        loadContent('np');
        htmx.ajax('GET', 'np.html?id=' + id, { target: '#content', swap: 'innerHTML', delay: "500ms" })
      } else {
        alert('This content is only available on the iTunes Store.')
      }
    } else {
      var src = id.slice(5);
      if (audio_) audio_.pause();
      const audio = audio_ = new Audio(src);
      audio.play();
    }
  }
  function playNextOrLast(id, type) {
    npId = "viewonly"
    loadContent('np');
    htmx.ajax('GET', 'np.html?id=', { target: '#content', swap: 'innerHTML', delay: "500ms" })
    if (type == "later") {
      playLater.initCustomEvent("playLater", true, true, id);
      document.dispatchEvent(playLater);
    } else {
      playNext.initCustomEvent("playNext", true, true, id);
      document.dispatchEvent(playNext);
    }
  }
  function pausePlay(id, type) {
    pausePlayEvent.initCustomEvent("pausePlayEvent", true, true, type + id);
    document.dispatchEvent(pausePlayEvent);
  }

  function showNowPlayingScreen() {
    const npContainer = document.getElementById('np-container');
    if (npContainer.childElementCount > 0) {
      document.getElementById('content').innerHTML = '';
      while (npContainer.firstChild) {
        document.getElementById('content').appendChild(npContainer.firstChild);
      }
      document.getElementById('content').style.display = "inline-flex";
      document.getElementById('content').style.height = "fit-content";
      npContainer.style.display = "none";
      return true;
    }
    return false;
  }

  function hideNowPlayingScreen() {
    const content = document.getElementById('content');
    const npScreen = content.querySelector('#np');
    if (npScreen) {
      const npContainer = document.getElementById('np-container');
      npContainer.innerHTML = '';
      while (content.firstChild) {
        npContainer.appendChild(content.firstChild);
      }
      npContainer.style.display = "none";
      content.innerHTML = '';
    }
  }

  function getImageColors(imgUrl) {
    return new Promise((resolve, reject) => {
      const imgEl = new Image();
      imgEl.crossOrigin = 'Anonymous';

      imgEl.onload = function () {
        const canvas = document.createElement('canvas');
        const context = canvas.getContext('2d');
        let count = [], avg = [];

        function getMatchingGroupIndex(r, g, b) {
          const rgb = [r, g, b];
          if (avg.length === 0) {
            avg[0] = rgb;
            count[0] = 1;
            return;
          }
          for (let i = 0; i < avg.length; i++) {
            const [aR, aG, aB] = avg[i];
            if (
              Math.abs(aR - r) < 15 &&
              Math.abs(aG - g) < 15 &&
              Math.abs(aB - b) < 15
            ) {
              avg[i] = avg[i].map((x, ii) => (x * count[i] + rgb[ii]) / (count[i] + 1));
              count[i]++;
              return;
            }
          }
          count[avg.length] = 1;
          avg[avg.length] = rgb;
        }

        const ratio = Math.max(
          Math.ceil((imgEl.naturalHeight + 1) / 256),
          Math.ceil((imgEl.naturalWidth + 1) / 256)
        );
        const width = canvas.width = imgEl.naturalWidth / ratio;
        const height = canvas.height = imgEl.naturalHeight / ratio;

        context.scale(1 / ratio, 1 / ratio);
        context.drawImage(imgEl, 0, 0);

        const { data } = context.getImageData(0, 0, width, height);

        for (let x = 0; x < width; x += 2) {
          for (let y = 0; y < height; y += 2) {
            const ti = 4 * y * width + 4 * x;
            getMatchingGroupIndex(data[ti], data[ti + 1], data[ti + 2]);
          }
        }

        const bgIndex = count.indexOf(Math.max(...count));
        const bgColor = avg[bgIndex].map(x => Math.ceil(x));
        const bgRgbStr = `rgb(${bgColor.join(",")})`;

        function colorDistance(c1, c2) {
          return Math.sqrt(
            Math.pow(c1[0] - c2[0], 2) +
            Math.pow(c1[1] - c2[1], 2) +
            Math.pow(c1[2] - c2[2], 2)
          );
        }

        let maxDist = -1;
        let contrastColor = [0, 0, 0];

        for (let i = 0; i < avg.length; i++) {
          if (i === bgIndex) continue;
          const dist = colorDistance(avg[i], bgColor);
          if (dist > maxDist) {
            maxDist = dist;
            contrastColor = avg[i];
          }
        }

        if (bgColor[0] === contrastColor[0] &&
          bgColor[1] === contrastColor[1] &&
          bgColor[2] === contrastColor[2]) {
          contrastColor = bgColor.map(c => c < 128 ? c + 50 : c - 50);
        }
        var contrastRgbStr = `rgb(${contrastColor.map(x => Math.ceil(x)).join(",")})`;
        if (bgColor[0] === 0 && bgColor[1] === 0 && bgColor[2] === 0) {
          bgRgbStr = "#396E80";
        }
        if (contrastColor[0] === 0 && contrastColor[1] === 0 && contrastColor[2] === 0) {
          contrastRgbStr = "#E3E1DB";
        }
        resolve({
          bgColor: bgRgbStr,
          contrastColor: contrastRgbStr
        });
      };

      imgEl.onerror = function () {
        reject(new Error('Failed to load image at ' + imgUrl));
      };

      imgEl.src = imgUrl;
    });
  }

  function updateNpBtnArtwork(artworkUrl) {
    const npBtn = document.getElementById('np-btn');
    if (!npBtn) return;
    let img = npBtn.querySelector('.np-artwork-img');
    let icon = npBtn.querySelector('.material-symbols-outlined');
    if (artworkUrl && artworkUrl !== 'fallback.svg') {
      if (!img) {
        img = document.createElement('img');
        img.className = 'np-artwork-img';
        if (icon) icon.style.display = 'none';
        npBtn.appendChild(img);
      }
      img.src = artworkUrl;
      img.style.display = 'block';
      if (icon) icon.style.display = 'none';
      npBtn.classList.add('active');
    } else {
      if (img) img.style.display = 'none';
      if (icon) icon.style.display = 'block';
      npBtn.classList.remove('active');
    }
  }
</script>