<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width">
  <title>TuneGram</title>
  <link rel="icon" type="image/x-icon" href="favicon.png">
  <link rel="manifest" href="manifest.json">
  <link href="style.css" rel="stylesheet" type="text/css" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=MuseoModerno:ital,wght@0,100..900;1,100..900&family=Ubuntu:ital,wght@0,300;0,400;0,500;0,700;1,300;1,400;1,500;1,700&display=swap"
    rel="stylesheet">
  <link rel="stylesheet" href="https://use.typekit.net/rtp1cee.css">
  <link rel="manifest" href="manifest.json">
  <meta name="apple-music-app-name" content="TuneGram" />
  <meta name="apple-music-app-build" content="2.1.0" />
  <link rel="stylesheet"
    href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
  <script src="https://unpkg.com/htmx.org@1.9.10"
    integrity="sha384-D1Kt99CQMDuVetoL1lrYwg5t+9QdHe7NLX/SoJYkXDFfX37iInKRy5xLSi8nO7UC"
    crossorigin="anonymous"></script>
  <script src="https://js-cdn.music.apple.com/musickit/v3/musickit.js" data-web-components async></script>
  <script src="https://code.jquery.com/jquery-3.7.1.slim.js"
    integrity="sha256-UgvvN8vBkgO0luPSUl2s8TIlOSYRoGFAX4jlCIm9Adc=" crossorigin="anonymous"></script>
</head>

<body>
  <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
    <filter id="liquid-glass">
      <feGaussianBlur in="SourceGraphic" stdDeviation="10" result="blur" />
      <feColorMatrix in="blur" type="matrix" values="1 0 0 0 0  0 1 0 0 0  0 0 1 0 0  0 0 0 20 -10" result="goo" />
      <feBlend in="SourceGraphic" in2="goo" mode="normal" />
    </filter>
  </svg>
  <div class="header" style="height:82px;">
    <div id="nameplate" valign="left" style="border:none;margin-left:2%;flex-grow:1;display:flex;vertical-align: middle;">
      <p id="name" onclick="loadContent('nap')" hx-get="onboard.html" hx-target="#content"
      hx-swap="innerHTML swap:1s" style="width:auto;height:55px;vertical-align: middle;padding:10px">TuneGram</p>
    <button id="bug-btn"
      style="background-color:inherit;border:none;border-radius:8px;padding:10px;cursor:pointer;display:flex;align-items:center;justify-content:center;">
      <span class="material-symbols-outlined" style="font-size:2em;color:transparent;">bug_report</span>
    </button>
    </div>
    <div class="header-itms">
      <div title="Now Playing" class="header-itm" id="np-btn" onclick="loadContent('np-header')"
        hx-get="np.html?id=viewonly" hx-target="#content" hx-swap="innerHTML swap:1s">
        <p style="font-size:3em;text-align:center;" class="material-symbols-outlined">graphic_eq</p>
      </div>
      <div title="Search" class="header-itm" id="srch-btn" onclick="loadContent('srch')" hx-get="search.html"
        hx-target="#content" hx-swap="innerHTML swap:1s">
        <p style="font-size:3em;text-align:center;" class="material-symbols-outlined">search</p>
      </div>
    </div>
  </div>
  <div id="mobile-nav">
    <button class="mobile-nav-btn" id="np-btn-mobile" onclick="loadContent('np-header')" hx-get="np.html?id=viewonly"
      hx-target="#content" hx-swap="innerHTML swap:1s">
      <span class="material-symbols-outlined">graphic_eq</span>
    </button>
    <button class="mobile-nav-btn" id="srch-btn-mobile" onclick="loadContent('srch')" hx-get="search.html"
      hx-target="#content" hx-swap="innerHTML swap:1s">
      <span class="material-symbols-outlined">search</span>
    </button>
  </div>
  <div id="content">
    <div class="moving-note">
      <p style="font-size:3em;text-align:center;margin-bottom:10%;margin-left:25%;margin-right:25%;margin-top:10%"
        class="material-symbols-outlined">music_note</p>
    </div>
  </div>
  <div id="np-container" style="display:none"></div>
</body>
<script>
  var audio_;
  var hiItsQue = false
  var queue = "";
  var methodType = "";
  var targetPractice = "";

  const queryParameters = { l: 'en-us' };
  function assignVar(type, num) {
    if (type == "album") {
      albumsToCount = num;
    } else if (type == "plist") {
      plistsToCount = num
    }
  }
  var tags = ["deluxe", "live", "acoustic", "explicit", "master", "remix", "version", "bonus", "original", "soundtrack", "remastered", "reissue", "re-recorded", "re-recording", "reimagined", "reimagining", "cover", "stripped down"];
  var plistWarns = [];
  var albumsToCount = 0;
  var toDrawAlbums = ""
  var albumsProcessed = 0;
  var foldersToCount = 0;
  var toDrawFolders = ""
  var foldersProcessed = 0;
  var songsToCount = 0;
  var toDrawSongs = ""
  var songsProcessed = 0;
  var plistsToCount = 0;
  var toDrawPlists = ""
  var plistsProcessed = 0;
  var tracksToCount = 0;
  var toDrawTracks = ""
  var tracksProcessed = 0;
  var heavyToCount = 0;
  var toDrawHeavy = ""
  var heavyProcessed = 0;
  var toDrawRecs = "";
  var recsProcessed = 0;
  var recsToCount = 0;
  function boundToString(rect) {
    return `rect(w=${rect.width}, h=${rect.height})`;
  }
  document.body.addEventListener('htmx:afterSwap', function (res) {
    document.getElementById('content').style.height = "fit-content";
  })
  document.body.addEventListener('htmx:beforeSwap', function () {
    document.getElementById('content').style.height = "87.5vh";
  })
  function resetNowPlayingColors() {
    document.body.style.backgroundColor = "#E3E1DB";
    document.body.style.color = "#2F3633";
    
    const header = document.querySelector('.header');
    if (header) {
      header.style.backgroundColor = "#E3E1DB";
      header.style.opacity = ""; // Reset opacity
    }

    const name = document.querySelector('#name');
    if (name) {
      name.style.color = "#8DA8AD";
    }
    
    document.documentElement.style.setProperty('--np-bg-primary', '');
    document.documentElement.style.setProperty('--np-bg-secondary', '');
    document.documentElement.style.setProperty('--np-text-primary', '');
    document.documentElement.style.setProperty('--np-text-secondary', '');
    document.documentElement.style.setProperty('--np-accent', '');
    
    document.querySelectorAll('.focus-subheading').forEach(el => {
      el.style.color = '';
    });
    document.querySelectorAll('.focus-heading').forEach(el => {
      el.style.color = '';
    });
    
    const queueContent = document.getElementById('queue-content');
    if (queueContent) {
      queueContent.style.backgroundColor = '';
      queueContent.style.color = '';
    }
    
    // Reset queue header and arrow colors
    const queueHeader = document.getElementById('queue-header');
    if (queueHeader) {
      queueHeader.style.color = '';
    }
    
    const queueArrow = document.getElementById('queue-arrow');
    if (queueArrow) {
      queueArrow.style.color = '';
    }
    
    // Reset theme attributes
    document.querySelectorAll('apple-music-progress').forEach(el => el.removeAttribute("theme"));
    document.querySelectorAll('apple-music-playback-controls').forEach(el => el.removeAttribute("theme"));
    
    // Reset contrast color CSS variable
    document.documentElement.style.removeProperty('--contrast-color');
    
    document.querySelectorAll('.header-itm').forEach(a => a.style.background = '');
    document.querySelectorAll('.header-itm').forEach(a => a.style.border = '');
    document.querySelectorAll('.header-itm').forEach(a => a.style.color = '');
  }
  
  function resetLyricVariables() {
    // Reset any lyric lines that might exist
    const lyricLines = document.querySelectorAll('.lyric-line');
    lyricLines.forEach(line => {
      line.classList.remove('highlight');
      line.style.transform = '';
      line.style.opacity = '';
    });
    
    // Clear any scroll timeouts
    if (window.scrollTimeout) {
      clearTimeout(window.scrollTimeout);
      window.scrollTimeout = null;
    }
    
    // Reset highlight index
    window.currentHighlightIndex = -1;
    document.querySelectorAll('.lyric-break-note').forEach(note => {
      note.style.opacity = '0.3';
      note.style.filter = 'brightness(1)';
      note.style.transform = 'scale(1)';
    });
  }
  
  function toggleQueue() {
    const queueContent = document.getElementById('queue-content');
    const queueArrow = document.getElementById('queue-arrow');
    
    if (queueContent.style.maxHeight === '0px' || queueContent.style.maxHeight === '') {
      // Expand the queue upward - use different heights for desktop vs mobile
      const isMobile = window.innerWidth <= 650;
      const maxHeight = isMobile ? '50vh' : '60vh';
      queueContent.style.maxHeight = maxHeight;
      queueContent.style.opacity = '1';
      queueContent.style.visibility = 'visible';
      queueArrow.style.transform = 'rotate(180deg)';
    } else {
      // Collapse the queue
      queueContent.style.maxHeight = '0px';
      queueContent.style.opacity = '0';
      queueContent.style.visibility = 'hidden';
      queueArrow.style.transform = 'rotate(0deg)';
    }
  }

  function loadContent(page) {
    if (page !== "np" && page !== "np-header") {
      hideNowPlayingScreen();
      resetNowPlayingColors();
      document.body.style.backgroundColor = "#E3E1DB";
      // Remove now playing class to restore body overflow
      document.body.classList.remove('np-active');
    } else {
      // Add now playing class to hide body overflow
      document.body.classList.add('np-active');
    }
    if (page === "np" || page === "np-header") {
      if (showNowPlayingScreen()) {
        if (page == "np-header") {
          npId = "viewonly"
          document.querySelector('#np-btn').style.color = "#396E80";
          document.querySelector('#srch-btn').style.color = "#2F3633";
        }
        if (page == "np") {
          document.querySelector('#np-btn').style.color = "#396E80";
          document.querySelector('#srch-btn').style.color = "#2F3633";
        }
        return;
      }
    }

    document.getElementById('content').innerHTML = `<div class="moving-note"><p style="font-size:3em;text-align:center;margin-bottom:10%;margin-left:25%;margin-right:25%;margin-top:10%" class="material-symbols-outlined">music_note</p>`
    document.getElementById('content').style.display = "inline-flex";

    if (page == "srch") {
      document.querySelector('#srch-btn').style.color = "#396E80";
      document.querySelector('#np-btn').style.color = "#2F3633";
    }
    if (page == "np-header" || page == "np") {
      document.querySelector('#np-btn').style.color = "#396E80";
      document.querySelector('#srch-btn').style.color = "#2F3633";
    }
    if (page == "nap") {
      document.querySelector('#srch-btn').style.color = "#2F3633";
      document.querySelector('#np-btn').style.color = "#2F3633";
    }
  }
  const listenSearch = document.createEvent("CustomEvent");
  const listenOnBoard = document.createEvent("Event");
  const infoScreen = document.createEvent("CustomEvent");
  const nowPlayingEvent = document.createEvent('CustomEvent')
  const pausePlayEvent = document.createEvent('CustomEvent')
  const playLater = document.createEvent('CustomEvent')
  const playNext = document.createEvent('CustomEvent')
  const listenSeeMore = document.createEvent('CustomEvent')
  function getSearch() {
    htmx.ajax('GET', 'search.html', { target: '#content', swap: 'innerHTML', delay: "500ms" })
  }
  document.addEventListener('musickitloaded', async function () {
    try {
      await MusicKit.configure({
        developerToken: 'eyJhbGciOiJFUzI1NiIsImtpZCI6IlFOMjVSSkFEQk4iLCJ0eXAiOiJKV1QifQ.eyJpc3MiOiJRN0MyVEMzNlQyIiwiaWF0IjoxNzU3NjI0ODk1LCJleHAiOjE3NjEwODA4OTUsIm9yaWdpbiI6WyJodHRwczovL3RnLmNvbWljc2VydmVyLm9yZyJdfQ.Jwi7O__04qqmIonDbdSqzyPnN7nidhxZW6Wu7aDwDW8TCQhbotA2XAO2BFUDBe9AsrrqI_7R8DsDle6_IGHlJA',
        app: {
          name: 'TuneGram',
          build: '2.1.0',
        },
        debug: true,
        suppressErrorDialog: false
      });
      const music = MusicKit.getInstance();

      function toBase58(str) {
        const alphabet = "123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz";
        let bytes = new TextEncoder().encode(str);
        let num = BigInt('0x' + Array.from(bytes).map(b => b.toString(16).padStart(2, '0')).join(''));
        let encoded = '';
        while (num > 0) {
          let rem = num % 58n;
          num = num / 58n;
          encoded = alphabet[Number(rem)] + encoded;
        }

        for (let b of bytes) {
          if (b === 0) encoded = '1' + encoded;
          else break;
        }

        return encoded.replace(/(.{8})/g, '$1-').replace(/-$/, '');
      }

      var bugBtn = document.getElementById('bug-btn');
      if (bugBtn) {
        bugBtn.addEventListener('click', async function () {
          const music = window.MusicKit ? window.MusicKit.getInstance() : null;
          if (music) {
            try {
              const userToken = await music.authorize();
              prompt('Token for Manual Entry: ', userToken);
            } catch (err) {
              alert('Authorization failed: ' + err);
            }
          }
        });
      }

      const storefront = music.storefrontId || 'us';
      if (!music.isAuthorized) {
        document.querySelector('#np-btn').outerHTML = ""
        document.querySelector('#srch-btn').outerHTML = ""
        document.querySelector('#nameplate').outerHTML = `<div valign="left" id="nameplate" onclick="getSearch()" style="border:none;margin-left:2%;width:100vw">
      <span class="name title-font">TuneGram</span>
      <span class="name title-font" style="font-size:1.5em">Preview</span>
    </div>`
        getSearch()
      }
      document.addEventListener("listenSearch", (e) => {
        searchTerm(e.detail)
      }, false);
      async function searchTerm(term) {
        await music.api.music(`/v1/catalog/${storefront}/search`, { term: term, types: 'albums,songs,playlists' }).then((res) => {
          if (res.data.results) {
            if (res.data.results.songs) {
              var songs = res.data.results.songs.data;
              songs.forEach(searchSongs)
            } else {
              drawSadResults('song');
            }
            if (res.data.results.albums) {
              var albums = res.data.results.albums.data;
              albums.forEach(searchAlbums)
            } else {
              drawSadResults('album');
            }
            if (res.data.results.playlists) {
              var plists = res.data.results.playlists.data;
              plists.forEach(searchPlists)
            } else {
              drawSadResults('plist');
            }
          } else {
            drawSadResults('both');
          }
        }).catch((err) => {
          console.error(err)
        })
      }
      async function infoDo(id) {
        if (id.startsWith('pl')) {
          await music.api.music(`/v1/catalog/${storefront}/playlists/${id}`, queryParameters).then(async (res) => {
            var plist = res.data.data;
            plist.forEach(drawInfo);
            console.log(res);
            await music.api.music(`/v1/catalog/${storefront}/playlists/${id}/tracks`, queryParameters).then((res) => {
              var tracks = res.data.data;
              tracks.forEach(appendTracks);
            }).catch(err => {
              console.log(err);
              if (err) {
                console.error(err);
                ["n/a"].forEach(appendTracks);
              }
            });
          });
        }
        if (id.startsWith('p') && !id.startsWith('pl')) {
          await music.api.music('/v1/me/library/playlists/' + id, queryParameters).then(async (res) => {
            var plist = res.data.data;
            plist.forEach(drawInfo)
            console.log(res)
            await music.api.music(`/v1/me/library/playlists/${id}/tracks`, queryParameters).then((res) => {
              var tracks = res.data.data;
              tracks.forEach(appendTracks)
            }).catch(err => {
              console.log(err)
              if (err) {
                console.error(err)
                ["n/a"].forEach(appendTracks)
              }
            })
          })
        } else if (id.startsWith('s')) {
          var songId = id.slice(1)
          await music.api.music(`/v1/catalog/${storefront}/songs/` + songId, queryParameters).then(async (res) => {
            var albumOfSong = res.data.data[0].relationships.albums.data[0].id
            await music.api.music(`/v1/catalog/${storefront}/albums/` + albumOfSong, queryParameters).then((res) => {
              var album = res.data.data;
              if (album[0].relationships.tracks.data) {
                var tracks = album[0].relationships.tracks.data;
                tracks.forEach(appendTracks)
              }
              album.forEach(drawInfo)
            })
          })
        } else if (id.startsWith('i')) {
          await music.api.music("/v1/me/library/albums/" + id, queryParameters).then(async (res) => {
            var songReportingId = res.data.data[0].attributes.playParams.reportingId;
            await music.api.music(`/v1/catalog/${storefront}/songs/` + songReportingId, queryParameters).then(async (res) => {
              var albumOfSong = res.data.data[0].relationships.albums.data[0].id
              await music.api.music(`/v1/catalog/${storefront}/albums/` + albumOfSong, queryParameters).then((res) => {
                var album = res.data.data;
                if (album[0].relationships.tracks.data) {
                  var tracks = album[0].relationships.tracks.data;
                  tracks.forEach(appendTracks)
                }
                album.forEach(drawInfo)
              })
            });
          })
        } else if (!id.startsWith('p') && !id.startsWith('l') && !id.startsWith('i')) {
          await music.api.music(`/v1/catalog/${storefront}/albums/` + id, queryParameters).then((res) => {
            var album = res.data.data;
            if (album[0].relationships.tracks.data) {
              var tracks = album[0].relationships.tracks.data;
              tracks.forEach(appendTracks)
            }
            album.forEach(drawInfo)
          })
        } else if (id.startsWith('l')) {
          await music.api.music('/v1/me/library/albums/' + id, queryParameters).then((res) => {
            var album = res.data.data;
            if (album[0].relationships.tracks.data) {
              var tracks = album[0].relationships.tracks.data;
              tracks.forEach(appendTracks)
            }
            album.forEach(drawInfo)
          });
        }
      }
      function loadMore(type) {
        methodType = type;
        if (methodType == "heavy") {
          targetPractice = "#heavycards"
        } else if (methodType == "album") {
          targetPractice = "#bigcards"
        } else if (methodType == "playlist") {
          targetPractice = "#smallcards"
        } else if (methodType == "recs") {
          targetPractice = "#rec-cards"
        }
        htmx.ajax('GET', 'seemore.html', { target: targetPractice, swap: 'afterend' })
      }
      document.addEventListener("infoScreen", (e) => {
        infoDo(e.detail)
      }, false);
      if (music.isAuthorized) {
        htmx.ajax('GET', 'onboard.html', { target: '#content', swap: 'innerHTML', delay: "2s" })
        document.body.addEventListener('htmx:afterSwap', function (res) {
          var resUlt = res.detail.requestConfig.path;
          if (resUlt.includes("np.html")) {
            // Reset lyric variables when NP screen loads
            resetLyricVariables();
            
          }
        })
        document.addEventListener("listenSeeMore", async (e) => {
          seeMore();
        })
        async function seeMore() {
          var rawMethod = methodType;
          var chosenFunc = "";
          var methodUrl = ""
          var offSet = document.querySelector(targetPractice).children.length + 1;
          if (rawMethod == "heavy") {
            methodUrl = "/v1/me/history/heavy-rotation";
            chosenFunc = drawHeavy;
          } else if (rawMethod == "album") {
            methodUrl = "/v1/me/library/albums";
            chosenFunc = drawAlbums;
          } else if (rawMethod == "playlist") {
            methodUrl = "/v1/me/library/playlists";
            chosenFunc = drawPlists;
          }
          const greaterAlbums = await music.api.music(methodUrl, { offset: offSet }).then((data) => {
            if (data.data) {
              var res = data.data.data;
              if (res.length == 0) {
                $(targetPractice + ' card').last()[0].scrollIntoView({
                  behavior: "smooth",
                  block: "start",
                  block: 'nearest',
                  inline: 'center'
                });
              } else {
                $(targetPractice + ' card').last()[0].scrollIntoView({
                  behavior: "smooth",
                  block: "start",
                  block: 'nearest',
                  inline: 'center'
                });
                res.forEach(chosenFunc)
              }
            }
          });
        }
        document.addEventListener("listenOnBoard", (e) => {
          document.getElementById("mix-more").addEventListener("click", function () {
            loadMore('playlist')
          });
          document.getElementById("alb-more").addEventListener("click", function () {
            loadMore('album')
          });
          document.getElementById("hvy-more").addEventListener("click", function () {
            loadMore('heavy')
          });
          loadLibrary()
        }, false);
        document.addEventListener("pausePlayEvent", async (e) => {
          var typee = e.detail
          var type = typee.slice(0, 2);
          var id = typee.slice(2)
          if (type == "re") {
            await music.skipToPreviousItem()
          } else if (type == "ff") {
            await music.skipToNextItem()
          } else {
            if (music.isPlaying == true) {
              music.pause()

            } else {
              music.play();

            }
          }
        }, false);
        document.addEventListener("nowPlayingEvent", async (e) => {
          loadVisuals(queue, e.detail)
          var songId = [e.detail];
          if (e.detail !== "") {
            if (e.detail !== "viewonly") {
              await music.setQueue({ songs: songId, startPlaying: true })
              loadVisuals(music.queue.items, e.detail)
            } else {
              if (music.queue.currentItem) {
                loadVisuals(music.queue.items, music.queue.currentItem.id);
                (music.queue.items).forEach(appendTracks)
                loadLyrics()
                updateHighlightedTrack();
              } else {
                ["n/a"].forEach(appendTracks)
              }
            }
          }
        }, false);
      }
      document.addEventListener("playLater", async (e) => {
        if ((music.queue.items).length == 0) {
          queue = await music.setQueue({ songs: [e.detail], startPlaying: true });
          loadVisuals(queue, e.detail)
        } else {
          music.playLater({ songs: [e.detail] })
          queue = music.queue.items;
        }
      }, false);
      document.addEventListener("playNext", async (e) => {
        if ((music.queue.items).length == 0) {
          queue = await music.setQueue({ songs: [e.detail], startPlaying: true });
          loadVisuals(queue, e.detail)
        } else {
          music.playNext({ songs: [e.detail] })
          queue = music.queue.items;
        }
      }, false);
      music.addEventListener('nowPlayingItemDidChange', ({ item }) => {
        // Reset lyric variables when song changes
        resetLyricVariables();
        
        if (item !== undefined) {
          loadVisuals(queue, item.id)
          updateHighlightedTrack();
          loadLyrics()
        }
      });
      music.addEventListener('queueItemsDidChange', ({ item }) => {
        const queue = music.queue.items;
        queue.forEach(appendTracks)
        loadVisuals(queue, music.queue.currentItem)
        updateHighlightedTrack();
      });
      function loadVisuals(queue, id) {
        var songPlaying = music.queue.currentItem;
        if (songPlaying !== undefined) {
          var queueItems = music.queue.items;
          hiItsQue = true;
          var root = songPlaying.attributes;
          var art = "";
          var bgColor = "#396E80";
          if (root.artwork) {
            if (root.artwork.url) {
              art = MusicKit.formatArtworkURL(root.artwork, 500, 500);
              getImageColors(art).then(({ bgColor, contrastColor }) => {
                bgColor = bgColor || "#396E80";
                document.body.style.backgroundColor = `${bgColor}`;
                document.body.style.color = `${contrastColor}`;
                var theme = getDark(bgColor);
                var invert = (theme == "dark") ? "light" : "dark"
                // Set theme for all progress bars and playback controls
                document.querySelectorAll('apple-music-progress').forEach(el => el.setAttribute("theme", theme));
                document.querySelectorAll('apple-music-playback-controls').forEach(el => el.setAttribute("theme", theme));
                
                // Set contrast color CSS variable for Apple Music controls
                document.documentElement.style.setProperty('--contrast-color', contrastColor);
                document.querySelectorAll('.focus-subheading').forEach(a => a.style.color = `${contrastColor}`);
                document.querySelectorAll('.focus-heading').forEach(a => a.style.color = `${contrastColor}`);
                if(document.querySelectorAll('detail-label')){
                  document.querySelectorAll('detail-label').forEach(a => a.style.color = `${contrastColor}`);
                  document.querySelectorAll('detail-label').forEach(a => a.style.border = `1px solid ${contrastColor}`);
                }
                const header = document.querySelector('.header');
                const name = document.querySelector('#name');
                if (header) {
                   header.style.backgroundColor = bgColor;
                   header.style.borderBottom = `none`;
                }
                if (name) {
                  name.style.color = contrastColor;
                }
                document.querySelectorAll('.header-itm').forEach(a => a.style.background = `transparent !important`);
                document.querySelectorAll('.header-itm').forEach(a => a.style.border = `none !important`);
                document.querySelectorAll('.header-itm').forEach(a => a.style.color = `${contrastColor}`);
                document.querySelectorAll('#greater-pc-desktop').forEach(a => a.style.background = `transparent !important`);
                document.querySelectorAll('#greater-pc-desktop').forEach(a => a.style.border = `none !important`);
                document.querySelectorAll('#greater-pc-desktop').forEach(a => a.style.color = `${contrastColor}`);
                document.querySelectorAll('#greater-pc-desktop p').forEach(a => a.style.color = `${contrastColor}`);
                // Update queue content background and text colors
                const queueContent = document.getElementById('queue-content');
                if (queueContent) {
                  queueContent.style.backgroundColor = bgColor;
                  queueContent.style.color = contrastColor;
                }
                
                // Update queue header colors
                const queueHeader = document.getElementById('queue-header');
                if (queueHeader) {
                  queueHeader.style.color = contrastColor;
                }
                
                // Update queue arrow color
                const queueArrow = document.getElementById('queue-arrow');
                if (queueArrow) {
                  queueArrow.style.color = contrastColor;
                }
              });
            }
          } else {
            art = "fallback.svg"
          }
          var detailSubheading = "";
          var finalName = "";
          var finalAlbumName = "";
          var name = (root.name).toLowerCase();
          var albumName = (root.albumName).toLowerCase();
          if (name.includes('(') || name.includes('[')) {
            var detailSub = "";
            if (name.includes('(') && (tags.some(tag => name.includes(tag)) || /\b(19|20)\d{2}\b/.test(name))) {
              detailSub = (root.name).split('(')[1].split(')')[0];
              finalName = (root.name).split('(')[0].split('[')[0].trim();
              detailSubheading = `<detail-subheading><detail-label>${detailSub}</detail-label></detail-subheading>`;
            } else if (name.includes('[') && (tags.some(tag => name.includes(tag)) || /\b(19|20)\d{2}\b/.test(name))) {
              detailSub = (root.name).split('[')[1].split(']')[0];
              finalName = (root.name).split('(')[0].split('[')[0].trim();
              detailSubheading = `<detail-subheading><detail-label>${detailSub}</detail-label></detail-subheading>`;
            }
          } else {
            finalName = root.name;
            finalAlbumName = root.albumName;
          }
          if (albumName.includes('(') || albumName.includes('[')) {
            console.log('Found a parenthesis or bracket in the album name: ' + name);
            finalAlbumName = (root.albumName).split('(')[0].split('[')[0].trim();
          }
          document.querySelector('#info-wrapper-np #info-title').innerHTML = finalName
          document.querySelector('#info-wrapper-np #info-artist').innerHTML = root.artistName
          document.querySelector('#info-wrapper-np #info-album').innerHTML = finalAlbumName
          document.querySelector('#np #info-img').src = art
          document.querySelector('#info-wrapper-np #info-details').innerHTML = detailSubheading;
        } else {
          document.querySelector('#info-wrapper-np #info-title').innerHTML = 'Not Playing';
          document.querySelector('#info-wrapper-np #info-artist').innerHTML = '';
          document.querySelector('#info-wrapper-np #info-album').innerHTML = '';
          document.querySelector('#np #info-img').src = 'fallback.svg';
        }
      }
      function converter(millis) {
        var minutes = Math.floor(millis / 60000);
        var seconds = ((millis % 60000) / 1000).toFixed(0);
        return minutes + ":" + (seconds < 10 ? '0' : '') + seconds;
      }
      function appendTracks(item, index, array) {
        if (item === "n/a") {
          console.warn('No appendable tracks to Queue or Tracklist.');
          document.getElementById('infobox').classList.remove('skeleton-page');
        } else {
          tracksToCount = array.length;
          var title = item.attributes.name
          var runtime = item.attributes.durationInMillis;
          var id;
          if (music.isAuthorized) {
            id = item.id
          } else {
            id = "prev+" + item.attributes.previews[0].url
          }
          var art = ""
          if (item.attributes.artwork) {
            art = MusicKit.formatArtworkURL(item.attributes.artwork, 25, 25);
          } else {
            art = "fallback.svg"
          }
          var idIcon = "play_arrow";
          var html = ` <tr>
            <td class="material-symbols-outlined general-music-control" onclick="musicPlay('${id}', '${art}')">${idIcon}</td>
            <td class="song-title">${title}</td>
            <td>${converter(runtime)}</td>`
          queuecontrols: if (music.isAuthorized) {
            if (document.querySelector("#np")) {
              if (((document.querySelector("#np").parentElement).parentElement).getAttribute("id") !== "np-container") {
                document.getElementById('tracklist').innerHTML = `
  <th class="labels">Play</th>
  <th class="labels">Name</th>
  <th class="labels">Runtime</th>`
                break queuecontrols;
              }
            }
            document.getElementById('tracklist').innerHTML = `
  <th class="labels">Play</th>
  <th class="labels">Name</th>
  <th class="labels">Runtime</th>
  <th class="labels">Queue</th>`
            html += `<td class="material-symbols-outlined general-music-control" onclick="playNextOrLast('${id}', 'next')">queue_play_next</td>
            <td class="material-symbols-outlined general-music-control" onclick="playNextOrLast('${id}', 'later')">add_to_queue</td>
            </tr>`
          } else {
            html += "</tr>"
          }
          if (hiItsQue == true) {
            hiItsQue = false;
            // Potential for queue specialness in Now Playing view
          }
          tracksProcessed++
          toDrawTracks += html
          if (tracksProcessed == tracksToCount && tracksProcessed !== 0) {
            document.querySelector('#tracklist').innerHTML += toDrawTracks;
            if (document.querySelectorAll('.queue-trklst tr').length > 1) {
              updateHighlightedTrack()
            }
            tracksProcessed = 0;
            toDrawTracks = "";
            document.getElementById('infobox').classList.remove('skeleton-page')
          }
        }
      }
      function loadLyrics() {
        var songName = music.queue.currentItem ? music.queue.currentItem.attributes.name : '';
        var artistName = music.queue.currentItem ? music.queue.currentItem.attributes.artistName : '';
        var albumName = music.queue.currentItem ? music.queue.currentItem.attributes.albumName : '';
        var dur = music.queue.currentItem ? music.queue.currentItem.attributes.durationInMillis : '';
        if (songName && artistName && albumName && dur) {
          var duration = dur / 1000;
          document.querySelector('#lyrics').innerHTML = '<p>Loading lyrics...</p>';
          const cover = document.querySelector('#np #info-img').src;
          getImageColors(cover).then(({ bgColor, contrastColor }) => {
            var lightContrast = contrastColor.replace(/rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,\s*[\d.]+)?\)/, (match, r, g, b) => `rgba(${r}, ${g}, ${b}, 0.5)`);
            bgColor = bgColor || "#396E80";
            contrastColor = contrastColor || "#E3E1DB";
            document.querySelector('#lyrics').style.backgroundColor = bgColor;
            document.querySelector('#lyrics').style.color = contrastColor;
            const sheet = document.styleSheets[0];
            for (let i = sheet.cssRules.length - 1; i >= 0; i--) {
              if (sheet.cssRules[i].selectorText === '.lyric-line' ||
                sheet.cssRules[i].selectorText === '.lyric-line.highlight') {
                sheet.deleteRule(i);
              }
            }
            document.styleSheets[0].insertRule(`.lyric-line { color: ${lightContrast} !important; margin-top: 1%; margin-bottom: 1%; font-size: 2em; cursor: pointer; transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1); opacity: 0.6; transform: translateY(0) translateX(0); }`, 0);
            document.styleSheets[0].insertRule(`.lyric-line.highlight { color: ${contrastColor} !important; opacity: 1; transform: translateY(-2px) translateX(-5px); text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3); }`, 0);
          });
          fetch(`https://lrclib.net/api/get?artist_name=${encodeURIComponent(artistName)}&track_name=${encodeURIComponent(songName)}`)
            .then(response => response.json())
            .then(data => {
              if (data.instrumental == false && (data.plainLyrics || data.syncedLyrics)) {
                if (data.syncedLyrics) {
                  const lyricsArray = data.syncedLyrics.split('\n').map(line => {
                    const match = line.match(/^\[(\d{2}:\d{2}\.\d{2})\]\s*(.*)$/);
                    return match ? { time: match[1], text: match[2] } : null;
                  }).filter(Boolean);
                  var lyricsHtml = lyricsArray.map((line, index) => {
                    if (line.text === "") {
                      // Don't add lyric break symbols at the end
                      if (index === lyricsArray.length - 1) {
                        return '';
                      }
                      return `<p class=\"lyric-line lyric-break\" data-time=\"${line.time}\"><span class=\"material-symbols-outlined lyric-break-note" style=\"font-size:1.2em;vertical-align:middle;opacity:0.3;transition:all 0.8s cubic-bezier(0.4, 0, 0.2, 1);\">music_note</span></p>`;
                    } else {
                      return `<p class=\"lyric-line\" data-time=\"${line.time}\">${line.text}</p>`;
                    }
                  }).filter(html => html !== '').join('<br>');
                  document.querySelector('#lyrics').innerHTML = lyricsHtml;
                  
                  // Add fade-in effect to all lyric lines
                  const allLyricLines = document.querySelectorAll('.lyric-line');
                  allLyricLines.forEach((line, index) => {
                    line.style.opacity = '0';
                    line.style.transform = 'translateY(20px)';
                    setTimeout(() => {
                      line.style.transition = 'all 0.8s cubic-bezier(0.4, 0, 0.2, 1)';
                      line.style.opacity = '0.6';
                      line.style.transform = 'translateY(0)';
                    }, index * 50); // Stagger the fade-in
                  });
                  const css = `@media (max-width: 650px) { #lyrics { width: fit-content !important; } }`;
                  document.styleSheets[0].insertRule(css, 0);
                  // APPLE MUSIC-STYLE LYRICS SYSTEM
                  const lyricsDiv = document.getElementById('lyrics');
                  const lyricLines = document.querySelectorAll('.lyric-line');
                  let currentHighlightIndex = -1;
                  let isUserScrolling = false;
                  let scrollTimeout = null;
                  let animationFrame = null;

                  // Simple time parsing
                  function parseTime(timeStr) {
                    if (!timeStr) return NaN;
                    const [min, sec] = timeStr.split(':');
                    if (!min || !sec) return NaN;
                    return (parseInt(min) * 60 + parseFloat(sec)) * 1000;
                  }

                  // Handle user scrolling
                  if (lyricsDiv) {
                    lyricsDiv.addEventListener('scroll', function() {
                      isUserScrolling = true;
                      if (scrollTimeout) clearTimeout(scrollTimeout);
                      scrollTimeout = setTimeout(() => {
                        isUserScrolling = false;
                      }, 3000);
                    });
                  }

                  // Add click handlers for seeking
                  lyricLines.forEach((line) => {
                    line.addEventListener('click', function() {
                      const timeStr = line.getAttribute('data-time');
                      if (timeStr && music) {
                        const [min, sec] = timeStr.split(':');
                        const time = parseInt(min) * 60 + parseFloat(sec);
                        music.seekToTime(time);
                      }
                    });
                  });

                  // Apple Music-style staggered animation
                  function animateLyricTransition(newIndex, oldIndex) {
                    if (animationFrame) cancelAnimationFrame(animationFrame);
                    
                    const lines = Array.from(lyricLines);
                    const maxDistance = 3; // Maximum distance for animation effect
                    
                    lines.forEach((line, index) => {
                      const distance = Math.abs(index - newIndex);
                      
                      if (distance <= maxDistance) {
                        // Calculate stagger delay based on distance
                        const delay = distance * 50; // 50ms per line distance
                        const opacity = Math.max(0.3, 1 - (distance * 0.2));
                        const translateY = (index - newIndex) * 8; // 8px per line
                        const scale = Math.max(0.95, 1 - (distance * 0.02));
                        
                        setTimeout(() => {
                          line.style.transition = 'all 0.4s cubic-bezier(0.4, 0, 0.2, 1)';
                          line.style.transform = `translateY(${translateY}px) scale(${scale})`;
                          line.style.opacity = opacity;
                        }, delay);
                      } else {
                        // Reset lines that are too far
                        line.style.transition = 'all 0.3s ease';
                        line.style.transform = 'translateY(0) scale(1)';
                        line.style.opacity = '0.3';
                      }
                    });
                  }

                  // Center scroll function - always center the highlighted line
                  function scrollToCenter(targetLine) {
                    if (!targetLine || !lyricsDiv) return;
                    
                    const containerHeight = lyricsDiv.clientHeight;
                    const lineHeight = targetLine.offsetHeight;
                    const lineTop = targetLine.offsetTop;
                    const targetScroll = lineTop - (containerHeight / 2) + (lineHeight / 2);
                    
                    lyricsDiv.scrollTo({
                      top: Math.max(0, targetScroll),
                      behavior: 'smooth'
                    });
                  }


                  // Main highlight function with Apple Music-style effects
                  function updateLyricsHighlight() {
                    // Use MusicKit's audio element for better accuracy
                    const audio = document.querySelector('#apple-music-player') || document.querySelector('audio') || audio_;
                    const currentTime = audio ? audio.currentTime * 1000 : 0;
                    let newHighlightIndex = -1;

                    // Find current line
                    for (let i = 0; i < lyricLines.length; i++) {
                      const lineTime = parseTime(lyricLines[i].getAttribute('data-time'));
                      if (!isNaN(lineTime) && currentTime >= lineTime) {
                        newHighlightIndex = i;
                      }
                    }

                    // Only update if changed
                    if (newHighlightIndex !== currentHighlightIndex) {
                      // Remove all highlights first
                      lyricLines.forEach(line => {
                        line.classList.remove('highlight');
                      });

                      // Add highlight to current line
                      if (newHighlightIndex >= 0 && lyricLines[newHighlightIndex]) {
                        lyricLines[newHighlightIndex].classList.add('highlight');
                        
                        // Apply Apple Music-style staggered animation
                        animateLyricTransition(newHighlightIndex, currentHighlightIndex);
                        
                        // ALWAYS center the highlighted line
                        setTimeout(() => {
                          scrollToCenter(lyricLines[newHighlightIndex]);
                        }, 100); // Small delay to let animation start
                      } else {
                        // No active line, reset all
                        lyricLines.forEach(line => {
                          line.style.transition = 'all 0.3s ease';
                          line.style.transform = 'translateY(0) scale(1)';
                          line.style.opacity = '0.3';
                        });
                      }

                      currentHighlightIndex = newHighlightIndex;
                    }
                  }

                  // Start the highlight system
                  updateLyricsHighlight();
                  
                  // Update on time changes using MusicKit's audio element for better accuracy
                  const audio = document.querySelector('#apple-music-player') || document.querySelector('audio') || audio_;
                  if (audio) {
                    audio.addEventListener('timeupdate', updateLyricsHighlight);
                  }
                } else if (data.plainLyrics) {
                  var plainLyrics = data.plainLyrics.replace(/\n/g, "<br>");
                  document.querySelector('#lyrics').innerHTML = plainLyrics;
                }
              } else if (data.instrumental == true) {
                document.querySelector('#lyrics').innerText = 'Instrumental';
              } else {
                document.querySelector('#lyrics').innerText = 'Lyrics not found.';
              }
            })
        } else {
          document.querySelector('#lyrics').innerText = 'No song playing.';
        }
      }

      function updateHighlightedTrack() {
        if (queue && music.queue.position !== undefined) {
          document.querySelectorAll('.queue-trklst tr').forEach(tr => tr.classList.remove('playing'));
          document.querySelectorAll('.queue-trklst tr')[music.queue.position + 1].classList.add('playing');
        }
      }
      function drawInfo(item, index, array) {
        var fullDate = item.attributes.releaseDate;
        var cover = "fallback.svg";
        var sub = ""
        var subsub = ""
        if (item.attributes.artwork) {
          if (item.attributes.artwork.url) {
            cover = MusicKit.formatArtworkURL(item.attributes.artwork, 500, 500);
            getImageColors(cover).then(({ bgColor, contrastColor }) => {
              bgColor = bgColor || "#396E80";
              if (document.querySelector("#np")) {
                document.querySelector('#np #info-img').style.border = `3px solid ${bgColor}`;
              }
              document.querySelector('#info #info-img').style.border = `3px solid ${bgColor}`;
            });
          }
        } else {
          cover = "fallback.svg"
        }
        if (item.attributes.artistName) {
          sub = item.attributes.artistName;
        }
        if (item.attributes.releaseDate) {
          var dt = new Date(item.attributes.releaseDate);
          subsub = dt.getFullYear();
        }
        var detailSubheading = "";
        var name = (item.attributes.name).toLowerCase();
        if (name.includes('(') || name.includes('[')) {
          console.log('Found a parenthesis or bracket in the album name: ' + name);
          var detailSub = "";
          if (name.includes('(') && (tags.some(tag => name.includes(tag)) || /\b(19|20)\d{2}\b/.test(name))) {
            detailSub = (item.attributes.name).split('(')[1].split(')')[0];
          } else if (name.includes('[') && (tags.some(tag => name.includes(tag)) || /\b(19|20)\d{2}\b/.test(name))) {
            detailSub = (item.attributes.name).split('[')[1].split(']')[0];
          }
          item.attributes.name = (item.attributes.name).split('(')[0].split('[')[0].trim();
          detailSubheading = `<detail-subheading><detail-label>${detailSub}</detail-label></detail-subheading>`;
        }
        document.querySelector('#info-title').innerHTML = item.attributes.name;
        document.querySelector('#info-year').innerHTML = subsub;
        document.querySelector('#info-artist').innerHTML = sub;
        document.querySelector('#info #info-img').src = cover;
        document.querySelector("#info-details").innerHTML = detailSubheading;
        document.querySelector("#play-all").setAttribute('onclick', `playAll('${item.id}')`);
        document.querySelector("#shuffle-all").setAttribute('onclick', `shuffleAll('${item.id}')`);
      }
      async function loadLibrary() {
        if (!sessionStorage.getItem('plistStorage') || !sessionStorage.getItem('albumStorage') || !sessionStorage.getItem('heavyStorage') || !sessionStorage.getItem('recStorage')) {
          const greaterAlbums = await music.api.music('/v1/me/library/albums').then((data) => {
            if (data.data) {
              var albums = data.data.data
              albums.forEach(drawAlbums)
            }
          });
          await music.api.music('/v1/me/history/heavy-rotation').then((data) => {
            var heavyRotation = data.data.data;
            heavyRotation.forEach(drawHeavy)
          });
          const plists = await music.api.music('/v1/me/library/playlists').then(async (data) => {
            var plists = data.data.data
            plists.forEach(drawPlists)
          })
          const recs = await music.api.music('/v1/me/recommendations').then(async (data) => {
            var parentData = data.data.data
            var num = Math.random() * parentData.length | 0
            var recs = parentData[num].relationships.contents.data;
            var attrs = parentData[num].attributes.title.stringForDisplay;
            recs.forEach(drawRecs)
            document.querySelector("#rec-heading").innerHTML = attrs;
            sessionStorage.setItem("rec-heading-innerhtml", document.querySelector("#rec-heading").innerHTML);
          })
        } else {
          drawBoth()
        }
      }
      music.addEventListener('playbackStateDidChange', ({ oldState, state }) => {
        if (state == "10") {
          loadContent('onboard');
          htmx.ajax('GET', 'onboard.html', { target: '#content', swap: 'innerHTML' });
        }
      });

      window.shuffleAll = async function (id) {
        try {
          let apiUrl;
          let isPlaylist = false;
          
          // Determine if it's a playlist or album and construct the correct API URL
          if (id.startsWith('pl')) {
            // Catalog playlist
            apiUrl = `/v1/catalog/${storefront}/playlists/${id}`;
            isPlaylist = true;
          } else if (id.startsWith('p') && !id.startsWith('pl')) {
            // Library playlist
            apiUrl = `/v1/me/library/playlists/${id}`;
            isPlaylist = true;
          } else if (id.startsWith('i')) {
            // Library album
            apiUrl = `/v1/me/library/albums/${id}`;
          } else if (id.startsWith('l')) {
            // Library album (alternative format)
            apiUrl = `/v1/me/library/albums/${id}`;
          } else {
            // Catalog album (numeric ID or starts with 'a')
            apiUrl = `/v1/catalog/${storefront}/albums/${id}`;
          }
          
          const response = await music.api.music(apiUrl, { l: 'en-us' });
          const data = response?.data?.data?.[0];
          
          if (!data || !data.relationships || !data.relationships.tracks || !data.relationships.tracks.data) {
            console.error('No tracks found for', id);
            return;
          }
          
          const tracks = data.relationships.tracks.data;
          const ids = tracks.map(track => {
            // For library items, use the track ID directly
            // For catalog items, use reportingId if available
            if (isPlaylist || id.startsWith('i') || id.startsWith('l')) {
              return track.id;
            } else {
              return track.attributes?.playParams?.reportingId || track.id;
            }
          }).filter(Boolean);
          
          if (!ids.length) {
            console.error('No valid track IDs found');
            return;
          }
          
          loadContent('np');
          htmx.ajax('GET', 'np.html?id=', { target: '#content', swap: 'innerHTML', delay: "500ms" });
          
          // Shuffle the IDs
          const shuffledIds = [...ids].sort(() => Math.random() - 0.5);
          await music.setQueue({ songs: shuffledIds, startPlaying: true });
          queue = music.queue.items;
        } catch (error) {
          console.error('Error in shuffleAll:', error);
        }
      }

      window.playAll = async function (id) {
        try {
          let apiUrl;
          let isPlaylist = false;
          
          // Determine if it's a playlist or album and construct the correct API URL
          if (id.startsWith('pl')) {
            // Catalog playlist
            apiUrl = `/v1/catalog/${storefront}/playlists/${id}`;
            isPlaylist = true;
          } else if (id.startsWith('p') && !id.startsWith('pl')) {
            // Library playlist
            apiUrl = `/v1/me/library/playlists/${id}`;
            isPlaylist = true;
          } else if (id.startsWith('i')) {
            // Library album
            apiUrl = `/v1/me/library/albums/${id}`;
          } else if (id.startsWith('l')) {
            // Library album (alternative format)
            apiUrl = `/v1/me/library/albums/${id}`;
          } else {
            // Catalog album (numeric ID or starts with 'a')
            apiUrl = `/v1/catalog/${storefront}/albums/${id}`;
          }
          
          const response = await music.api.music(apiUrl, { l: 'en-us' });
          const data = response?.data?.data?.[0];
          
          if (!data || !data.relationships || !data.relationships.tracks || !data.relationships.tracks.data) {
            console.error('No tracks found for', id);
            return;
          }
          
          const tracks = data.relationships.tracks.data;
          const ids = tracks.map(track => {
            // For library items, use the track ID directly
            // For catalog items, use reportingId if available
            if (isPlaylist || id.startsWith('i') || id.startsWith('l')) {
              return track.id;
            } else {
              return track.attributes?.playParams?.reportingId || track.id;
            }
          }).filter(Boolean);
          
          if (!ids.length) {
            console.error('No valid track IDs found');
            return;
          }
          
          loadContent('np');
          htmx.ajax('GET', 'np.html?id=', { target: '#content', swap: 'innerHTML', delay: "500ms" });
          
          // Play in order (no shuffling)
          await music.setQueue({ songs: ids, startPlaying: true });
          queue = music.queue.items;
        } catch (error) {
          console.error('Error in playAll:', error);
        }
      }

    } catch (err) {
      console.error(err)
    }
  });
  document.querySelectorAll('#content')[0].style.display = "block";
  function drawRecs(item, index, array) {
    recsToCount = array.length;
    var cover = "";
    if (item.attributes.artwork) {
      cover = MusicKit.formatArtworkURL(item.attributes.artwork, 500, 500);
    } else if (!item.attributes.artwork && item.attributes.artistName) {
      return;
    }
    var subheading = "";
    if (item.attributes.artistName) {
      subheading = item.attributes.artistName;
    } else {
      var date = new Date(item.attributes.lastModifiedDate);
      var edited = (date.getMonth() + 1) + "/" + date.getDate() + "/" + date.getFullYear()
      subheading = `Edited: ${edited}`;
    }
    var card = `<card onclick="toAlbum('${item.id}')"><img src="${cover}"/><heading>${item.attributes.name}</heading><subheading>${subheading}</subheading></card>`
    recsProcessed++
    toDrawRecs += card
    if (recsProcessed == recsToCount && recsProcessed !== 0) {
      document.querySelector('#rec-cards').innerHTML += toDrawRecs
      var setStorageStr = toDrawRecs;
      if (sessionStorage.getItem('recStorage')) {
        setStorageStr = sessionStorage.getItem('recStorage') + toDrawRecs;
      }
      sessionStorage.setItem('recStorage', setStorageStr)
    }
  }
  function drawAlbums(item, index, array) {
    albumsToCount = array.length
    if (item.attributes.url) {
      item.id = item.attributes.url.split('/').pop();
    }
    if (!item.attributes.artwork) {
      albumsProcessed++
      return;
    }
    var name = (item.attributes.name).toLowerCase();
    if (item.attributes.name === undefined) {
      item.attributes.name = "Unknown Album";
    }
    var detailSubheading = "";
    if (name.includes('(') || name.includes('[')) {
      console.log('Found a parenthesis or bracket in the album name: ' + name);
      var detailSub = "";
      if (name.includes('(') && (tags.some(tag => name.includes(tag)) || /\b(19|20)\d{2}\b/.test(name))) {
        detailSub = (item.attributes.name).split('(')[1].split(')')[0];
      } else if (name.includes('[') && (tags.some(tag => name.includes(tag)) || /\b(19|20)\d{2}\b/.test(name))) {
        detailSub = (item.attributes.name).split('[')[1].split(']')[0];
      }
      item.attributes.name = (item.attributes.name).split('(')[0].split('[')[0].trim();
      detailSubheading = `<detail-subheading><detail-label>${detailSub}</detail-label></detail-subheading>`;
    }
    if (item.attributes.artistName === undefined) {
      item.attributes.artistName = "Unknown Artist";
    }
    if (item.attributes.releaseDate === undefined) {
      item.attributes.releaseDate = "Unknown Release Date";
    }
    if (item.attributes.playParams === undefined) {
      item.attributes.playParams = {
        reportingId: item.id
      }
    }
    var cover = MusicKit.formatArtworkURL(item.attributes.artwork, 500, 500);
    var card = `<card onclick="toAlbum('${item.id}')"><img src="${cover}"/><heading>${item.attributes.name}</heading><subheading>${item.attributes.artistName}</subheading>${detailSubheading}</card>`
    albumsProcessed++
    toDrawAlbums += card
    if (albumsProcessed == albumsToCount && albumsProcessed !== 0) {
      document.querySelector('#bigcards').innerHTML += toDrawAlbums;
      var setStorageStr = toDrawAlbums;
      if (sessionStorage.getItem('albumStorage')) {
        setStorageStr = sessionStorage.getItem('albumStorage') + toDrawAlbums;
      }
      sessionStorage.setItem('albumStorage', setStorageStr)
    }
  }
  function drawHeavy(item, index, array) {
    heavyProcessed++
    if (item.attributes) {
      heavyToCount = array.length
      var cover = "";
      if (item.attributes.artwork) {
        cover = MusicKit.formatArtworkURL(item.attributes.artwork, 500, 500);
      } else if (!item.attributes.artwork && item.attributes.artistName) {
        return;
      }
      var subheading = "";
      if (item.attributes.artistName) {
        subheading = item.attributes.artistName;
      } else {
        var date = new Date(item.attributes.lastModifiedDate);
        var edited = (date.getMonth() + 1) + "/" + date.getDate() + "/" + date.getFullYear()
        subheading = `Edited: ${edited}`;
      }
      var card = `<card onclick="toAlbum('${item.id}')"><img src="${cover}"/><heading>${item.attributes.name}</heading><subheading>${subheading}</subheading></card>`
      toDrawHeavy += card
      if (heavyProcessed == heavyToCount && heavyProcessed !== 0) {
        document.querySelector('#heavycards').innerHTML += toDrawHeavy
        var setStorageStr = toDrawHeavy;
        if (sessionStorage.getItem('heavyStorage')) {
          setStorageStr = sessionStorage.getItem('heavyStorage') + toDrawHeavy;
        }
        sessionStorage.setItem('heavyStorage', setStorageStr)
      }
    } else {
      console.warn('Couldn\'t append an item in Heavy Rotation. Likely a station.')
      if (heavyProcessed == heavyToCount && heavyProcessed !== 0) {
        document.querySelector('#heavycards').innerHTML += toDrawHeavy
        var setStorageStr = toDrawHeavy;
        if (sessionStorage.getItem('heavyStorage')) {
          setStorageStr = sessionStorage.getItem('heavyStorage') + toDrawHeavy;
        }
        sessionStorage.setItem('heavyStorage', setStorageStr)
      }
    }
  }
  function drawSadResults(type) {
    if (type == "album") {
      document.querySelector('#bigcards').remove()
      document.querySelector('#albums-results').remove()
    }
    if (type == "song") {
      document.querySelector('#songcards').remove()
      document.querySelector('#songs-results').remove()
    }
    if (type == "plist") {
      document.querySelector('#plistcards').remove()
      document.querySelector('#plist-results').remove()
    }
    if (type == "both") {
      document.querySelector('#bigcards').remove()
      document.querySelector('#songcards').remove()
      document.querySelector('#albums-results').remove()
      document.querySelector('#songs-results').remove()
    }
  }
  function searchAlbums(item, index, array) {
    albumsToCount = array.length
    var cover = MusicKit.formatArtworkURL(item.attributes.artwork, 500, 500);
    var name = (item.attributes.name).toLowerCase();
    console.log('Processing album: ' + name);
    var detailSubheading = "";
    if (name.includes('(') || name.includes('[')) {
      console.log('Found a parenthesis or bracket in the album name: ' + name);
      var detailSub = "";
      if (name.includes('(') && (tags.some(tag => name.includes(tag)) || /\b(19|20)\d{2}\b/.test(name))) {
        detailSub = (item.attributes.name).split('(')[1].split(')')[0];
      } else if (name.includes('[') && (tags.some(tag => name.includes(tag)) || /\b(19|20)\d{2}\b/.test(name))) {
        detailSub = (item.attributes.name).split('[')[1].split(']')[0];
      }
      item.attributes.name = (item.attributes.name).split('(')[0].split('[')[0].trim();
      detailSubheading = `<detail-subheading><detail-label>${detailSub}</detail-label></detail-subheading>`;
    }
    var card = `<card onclick="toAlbum('${item.id}')"><img src="${cover}"/><heading>${item.attributes.name}</heading><subheading>${item.attributes.artistName}</subheading>${detailSubheading}</card>`
    albumsProcessed++
    toDrawAlbums += card
    if (albumsProcessed == albumsToCount && albumsProcessed !== 0) {
      document.querySelector('#bigcards').innerHTML = toDrawAlbums
    }
  }
  function searchPlists(item, index, array) {
    plistsToCount = array.length
    var cover = MusicKit.formatArtworkURL(item.attributes.artwork, 1000, 1000);
    console.log(cover)
    getImageColors(cover).then(({ bgColor, contrastColor }) => {
      var date = new Date(item.attributes.lastModifiedDate);
      edited = (date.getMonth() + 1) + "/" + date.getDate() + "/" + date.getFullYear()
      var card = `<card onclick="toAlbum('${item.id}')"><img src="${cover}"/><heading>${item.attributes.name}</heading><subheading>Edited ${edited}</subheading></card>`
      plistsProcessed++
      toDrawPlists += card
      if (plistsProcessed == plistsToCount && plistsProcessed !== 0) {
        document.querySelector('#plistcards').innerHTML = toDrawPlists;
        plistsProcessed = 0;
        toDrawPlists = ""
      }
    }).catch((err) => {
      console.error('Error getting background color:', err);
    });
  }

  function searchSongs(item, index, array) {
    songsToCount = array.length
    var cover = MusicKit.formatArtworkURL(item.attributes.artwork, 1000, 1000);
    console.log(cover)
    getImageColors(cover).then(({ bgColor, contrastColor }) => {
      var card = `<card style="background-color:${bgColor};" onclick="toAlbum('s${item.id}')"><img src="${cover}"/><heading style="color:${contrastColor}">${item.attributes.name}</heading><subheading style="color:${contrastColor}">${item.attributes.artistName}</subheading></card>`
      songsProcessed++
      toDrawSongs += card
      if (songsProcessed == songsToCount && songsProcessed !== 0) {
        document.querySelector('#songcards').innerHTML = toDrawSongs;
        songsProcessed = 0;
        toDrawSongs = ""
      }
    }).catch((err) => {
      console.error('Error getting background color:', err);
    });
  }
  function drawBoth() {
    document.querySelector('#bigcards').innerHTML = sessionStorage.getItem('albumStorage')
    document.querySelector('#heavycards').innerHTML = sessionStorage.getItem('heavyStorage')
    document.querySelector('#smallcards').innerHTML = sessionStorage.getItem('plistStorage')
    document.querySelector('#rec-cards').innerHTML = sessionStorage.getItem('recStorage')
    document.querySelector("#rec-heading").innerHTML = sessionStorage.getItem("rec-heading-innerhtml");
  }
  function drawPlists(item, index, array) {
    plistsToCount = array.length
    var cover = "fallback.svg"
    if (item.attributes.artwork) {
      cover = MusicKit.formatArtworkURL(item.attributes.artwork, 500, 500)
    }
    if (item.attributes.name === undefined) {
      item.attributes.name = "Unknown Playlist";
    }
    if (item.attributes.playParams === undefined) {
      item.attributes.playParams = {
        reportingId: item.id
      }
    }
    var edited = "";
    if (item.attributes.lastModifiedDate === "1970-01-01T00:00:00Z") {
      edited = "Date Unknown";
    } else {
      var date = new Date(item.attributes.lastModifiedDate);
      edited = (date.getMonth() + 1) + "/" + date.getDate() + "/" + date.getFullYear()
    }
    var card = `<card onclick="toAlbum('${item.id}')"><img src="${cover}"/><heading>${item.attributes.name}</heading><subheading>Edited ${edited}</subheading></card>`
    plistsProcessed++
    toDrawPlists += card
    if (plistsProcessed == plistsToCount && plistsProcessed !== 0) {
      document.querySelector('#smallcards').innerHTML += toDrawPlists
      var setStorageStr = toDrawPlists;
      if (sessionStorage.getItem('plistStorage')) {
        setStorageStr = sessionStorage.getItem('plistStorage') + toDrawPlists;
      }
      sessionStorage.setItem('plistStorage', setStorageStr)
    }
  }
  var infoId = ""
  var npId = ""
  var searchId = ""
  function toAlbum(id) {
    infoId = id
    htmx.ajax('GET', 'info.html?id=' + id, { target: '#content', swap: 'innerHTML', delay: "500ms" })
  }

  async function toAlbumFromNowPlaying() {
    const music = window.MusicKit ? window.MusicKit.getInstance() : null;
    if (music && music.queue.currentItem) {
      const currentItem = music.queue.currentItem;
      const songName = currentItem.attributes.name;
      const artistName = currentItem.attributes.artistName;
      const albumName = currentItem.attributes.albumName;
      
      try {
        // For library songs, we can't use catalog API, so use search instead
        if (currentItem.id.startsWith('l.')) {
          // This is a library song - use search to find the album
          if (albumName && artistName) {
            const searchQuery = `${albumName} ${artistName}`;
            const searchResults = await music.api.search(searchQuery, { types: ['albums'], limit: 1 });
            
            if (searchResults.albums && searchResults.albums.data && searchResults.albums.data.length > 0) {
              const albumId = searchResults.albums.data[0].id;
              toAlbum(albumId);
              return;
            }
          }
        } else {
          // This is a catalog song - try to get album relationships
          const song = await music.api.music(`/v1/catalog/${music.storefrontId}/songs/${currentItem.id}`, {
            include: 'albums'
          });
          
          if (song.data && song.data[0] && song.data[0].relationships && song.data[0].relationships.albums && song.data[0].relationships.albums.data && song.data[0].relationships.albums.data.length > 0) {
            const albumId = song.data[0].relationships.albums.data[0].id;
            toAlbum(albumId);
            return;
          }
        }
        
        // Fallback: search for album using song and artist name
        if (songName && artistName) {
          const searchQuery = `${songName} ${artistName}`;
          const searchResults = await music.api.search(searchQuery, { types: ['songs'], limit: 1 });
          
          if (searchResults.songs && searchResults.songs.data && searchResults.songs.data.length > 0) {
            const foundSong = searchResults.songs.data[0];
            if (foundSong.relationships && foundSong.relationships.albums && foundSong.relationships.albums.data && foundSong.relationships.albums.data.length > 0) {
              const albumId = foundSong.relationships.albums.data[0].id;
              toAlbum(albumId);
              return;
            }
          }
        }
        
        // Final fallback: search for album directly
        if (albumName && artistName) {
          searchTerm(`${albumName} ${artistName}`);
        }
        
      } catch (error) {
        console.error('Error fetching album info:', error);
        // Final fallback: search for album using available info
        if (albumName && artistName) {
          searchTerm(`${albumName} ${artistName}`);
        } else if (songName && artistName) {
          searchTerm(`${songName} ${artistName}`);
        }
      }
    }
  }
  function musicPlay(id, art) {
    npId = id;
    if (!id.startsWith('prev+')) {
      if (id !== "itunesonly") {
        loadContent('np');
        htmx.ajax('GET', 'np.html?id=' + id, { target: '#content', swap: 'innerHTML', delay: "500ms" })
      } else {
        alert('This content is only available on the iTunes Store.')
      }
    } else {
      var src = id.slice(5);
      if (audio_) audio_.pause();
      const audio = audio_ = new Audio(src);
      audio.play();
    }
  }
  function playNextOrLast(id, type) {
    npId = "viewonly"
    loadContent('np');
    htmx.ajax('GET', 'np.html?id=', { target: '#content', swap: 'innerHTML', delay: "500ms" })
    if (type == "later") {
      playLater.initCustomEvent("playLater", true, true, id);
      document.dispatchEvent(playLater);
    } else {
      playNext.initCustomEvent("playNext", true, true, id);
      document.dispatchEvent(playNext);
    }
  }
  function pausePlay(id, type) {
    pausePlayEvent.initCustomEvent("pausePlayEvent", true, true, type + id);
    document.dispatchEvent(pausePlayEvent);
  }

  function showNowPlayingScreen() {
    const npContainer = document.getElementById('np-container');
    if (npContainer.childElementCount > 0) {
      document.getElementById('content').innerHTML = '';
      while (npContainer.firstChild) {
        document.getElementById('content').appendChild(npContainer.firstChild);
      }
      document.getElementById('content').style.display = "inline-flex";
      document.getElementById('content').style.height = "fit-content";
      npContainer.style.display = "none";
      return true;
    }
    return false;
  }

  function hideNowPlayingScreen() {
    const content = document.getElementById('content');
    const npScreen = content.querySelector('#np');
    if (npScreen) {
      const npContainer = document.getElementById('np-container');
      npContainer.innerHTML = '';
      while (content.firstChild) {
        npContainer.appendChild(content.firstChild);
      }
      npContainer.style.display = "none";
      content.innerHTML = '';
    }
  }

  function getImageColors(imgUrl) {
    return new Promise((resolve, reject) => {
      const imgEl = new Image();
      imgEl.crossOrigin = 'Anonymous';

      imgEl.onload = function () {
        const canvas = document.createElement('canvas');
        const context = canvas.getContext('2d');
        let count = [], avg = [];

        function getMatchingGroupIndex(r, g, b) {
          const rgb = [r, g, b];
          if (avg.length === 0) {
            avg[0] = rgb;
            count[0] = 1;
            return;
          }
          for (let i = 0; i < avg.length; i++) {
            const [aR, aG, aB] = avg[i];
            if (
              Math.abs(aR - r) < 15 &&
              Math.abs(aG - g) < 15 &&
              Math.abs(aB - b) < 15
            ) {
              avg[i] = avg[i].map((x, ii) => (x * count[i] + rgb[ii]) / (count[i] + 1));
              count[i]++;
              return;
            }
          }
          count[avg.length] = 1;
          avg[avg.length] = rgb;
        }

        const ratio = Math.max(
          Math.ceil((imgEl.naturalHeight + 1) / 256),
          Math.ceil((imgEl.naturalWidth + 1) / 256)
        );
        const width = canvas.width = imgEl.naturalWidth / ratio;
        const height = canvas.height = imgEl.naturalHeight / ratio;

        context.scale(1 / ratio, 1 / ratio);
        context.drawImage(imgEl, 0, 0);

        const { data } = context.getImageData(0, 0, width, height);

        for (let x = 0; x < width; x += 2) {
          for (let y = 0; y < height; y += 2) {
            const ti = 4 * y * width + 4 * x;
            getMatchingGroupIndex(data[ti], data[ti + 1], data[ti + 2]);
          }
        }

        const bgIndex = count.indexOf(Math.max(...count));
        const bgColor = avg[bgIndex].map(x => Math.ceil(x));
        const bgRgbStr = `rgb(${bgColor.join(",")})`;

        function colorDistance(c1, c2) {
          return Math.sqrt(
            Math.pow(c1[0] - c2[0], 2) +
            Math.pow(c1[1] - c2[1], 2) +
            Math.pow(c1[2] - c2[2], 2)
          );
        }

        let maxDist = -1;
        let contrastColor = [0, 0, 0];

        for (let i = 0; i < avg.length; i++) {
          if (i === bgIndex) continue;
          const dist = colorDistance(avg[i], bgColor);
          if (dist > maxDist) {
            maxDist = dist;
            contrastColor = avg[i];
          }
        }

        if (bgColor[0] === contrastColor[0] &&
          bgColor[1] === contrastColor[1] &&
          bgColor[2] === contrastColor[2]) {
          contrastColor = bgColor.map(c => c < 128 ? c + 50 : c - 50);
        }
        var contrastRgbStr = `rgb(${contrastColor.map(x => Math.ceil(x)).join(",")})`;
        if (bgColor[0] === 0 && bgColor[1] === 0 && bgColor[2] === 0) {
          bgRgbStr = "#396E80";
        }
        if (contrastColor[0] === 0 && contrastColor[1] === 0 && contrastColor[2] === 0) {
          contrastRgbStr = "#E3E1DB";
        }
        resolve({
          bgColor: bgRgbStr,
          contrastColor: contrastRgbStr
        });
      };

      imgEl.onerror = function () {
        reject(new Error('Failed to load image at ' + imgUrl));
      };

      imgEl.src = imgUrl;
    });
  }

  // Mouse activity detection for greater-pc-desktop
  let mouseActivityTimeout;
  
  function showGreaterPcDesktop() {
    const greaterPcDesktop = document.getElementById('greater-pc-desktop');
    if (greaterPcDesktop) {
      greaterPcDesktop.style.opacity = '1';
      greaterPcDesktop.style.transform = 'translateY(0)';
    }
  }
  
  function hideGreaterPcDesktop() {
    const greaterPcDesktop = document.getElementById('greater-pc-desktop');
    if (greaterPcDesktop) {
      greaterPcDesktop.style.opacity = '0';
      greaterPcDesktop.style.transform = 'translateY(100%)';
    }
  }
  
  function resetMouseActivityTimer() {
    clearTimeout(mouseActivityTimeout);
    showGreaterPcDesktop();
    mouseActivityTimeout = setTimeout(hideGreaterPcDesktop, 5000);
  }

  function getDark(rgbString) {
    const match = rgbString.match(/\d+/g);
  
    if (!match || match.length < 3) {
      console.error("Invalid");
      return null;
    }
  
    const r = parseInt(match[0], 10);
    const g = parseInt(match[1], 10);
    const b = parseInt(match[2], 10);

    const brightness = (r * 299 + g * 587 + b * 114) / 1000;
    return brightness < 128 ? "dark" : "light";
  }
  
  document.addEventListener('mousemove', resetMouseActivityTimer);
  document.addEventListener('mousedown', resetMouseActivityTimer);
  document.addEventListener('mouseup', resetMouseActivityTimer);
  document.addEventListener('scroll', resetMouseActivityTimer);

</script>
